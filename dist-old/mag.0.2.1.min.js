/*
* MagnumJS - By Michael Glazer March 2015
* https://github.com/magnumjs/mag.js
*/
function handleObject(e,t,n){var r={};Object.keys(n).forEach(function(e){"_"==e.substr(0,1)&&(r[e.substr(1)]=n[e])}),domElement.event(e,t,r),domElement.setAttrs(e,t,r);for(var o in n)domElement.replaceWithin(e,o,n[o])}var domElement={};domElement.remove=function(e){return(elem=document.getElementById(e)).parentNode.removeChild(elem)},domElement.val=function(e,t,n){for(var r=domElement.findByKey(e,t),o=0;o<r.length;o++){var l=r[o].item(e);-1!==["INPUT","TEXTAREA","SELECT"].indexOf(l.tagName)?l.value=n:(txt=document.createTextNode(n),l.innerText=txt.textContent)}},domElement.setAttrs=function(e,t,n){var r=domElement.findByKey(e,t);for(var o in n)for(var l=0;l<r.length;l++)0!=o.indexOf("on")&&r[l].item(e).setAttribute(o,n[o])},domElement.event=function(e,t,n){var r=domElement.findByKey(e,t);for(var o in n)if(0==o.indexOf("on"))for(var l=0;l<r.length;l++)r[l].item(e).addEventListener(o.substr(2),n[o])},domElement.replaceWithin=function(e,t,n){function r(e,t,n){if(e.hasChildNodes())for(var i=e.children,a=0,d=i.length;d>a;a++)i[a].firstChild&&(i[a].firstChild.nodeValue?(o(t,i[a],n),l(t,i[a],n)):r(i[a],t,n));else o(t,e,n),l(t,e,n)}function o(e,t,r){function o(e,t,r){e.nodeValue=e.nodeValue.replace(t,function(e,t){return r==t?n:e})}for(var l=0,i=t.attributes,a=i.length;a>l;l++){var d=i.item(l);o(d,e,r)}}function l(e,t,r){t.firstChild.nodeValue=t.firstChild.nodeValue.replace(e,function(e,t){return r==t?n:e})}this.pattern=this.pattern||RegExp("\\[\\[(.*?)\\]\\]","g"),r(e,this.pattern,t)},domElement.setTextContent=function(e,t){for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))},domElement.findByKey=function(e,t){var n=[".key","#key","key",'[name="key"]','[data-bind="key"]'];setSelectorMapKey=function(e){return n.join(",").replace(/KEY/gi,e).split(",")},getElement=function(e,t){return e.querySelectorAll(t)};var r=setSelectorMapKey(t),o=[];for(var l in r){var i,a=r[l];(i=getElement(e,a))&&i.length>0&&(i.selector=a,o.push(i))}return o},domElement.hasClass=function(e,t){return(" "+e.className+" ").indexOf(" "+t+" ")>-1},domElement.replaceClass=function(e,t){var n,r="",o=e.className.split(" ");for(n=0;n<o.length;n++)o[n]!==t&&(r+=o[n]+" ");e.className=r};var mod={modules:[],controllers:[],elements:[]};mod.submodule=function(e,t){var n=function(t){return(e.controller||function(){}).apply(this,t)}.bind({},t),r=function(n){arguments.length>1&&(t=t.concat([].slice.call(arguments,1)));var r=e.view.apply(e,t?[n].concat(t):[n]);return t[0]&&null!=t[0].key&&(r.attrs.key=t[0].key),r};n.$original=e.controller;var o={controller:n,view:r};return t[0]&&null!=t[0].key&&(o.attrs={key:t[0].key}),o},mod.getArgs=function(e){var t=mod.modules[e].controller&&mod.modules[e].controller.$$args?[mod.controllers[e]].concat(mod.modules[e].controller.$$args):[mod.controllers[e]];return t};var render={roots:[],templates:{}},runs={};render.redraw=function(e){this.fun||(this.fun=debounce(function(){for(var t,n=0;t=render.roots[n];n++)if(e.controllers[n]){var r=e.elements[n],o=e.getArgs(n);e.modules[n].view(r,e.controllers[n],o),Object.observe(o[0],debounce(function(e,t,n){var r=n.getArgs(t);render.interpolate(e,r[0])}.bind(null,r,n,e))),render.interpolate(r,o[0])}})),this.fun()},render.isTypeOf=function(e,t){return this.toString.call(t)==="[object "+e+"]"?!0:void 0},render.types=["Array","String","Object","Function"],render.interpolate=function(e,t){console.log("called");for(var n in t)if(render.isTypeOf("Array",t[n])){if(render.cache[n]!=JSON.stringify(t[n])){var r=domElement.findByKey(e,n);if(r.length<1)continue;var o,l=r[0].item(e).parentNode;if(render.templates[n]){for(;l.firstChild;)l.removeChild(l.firstChild);o=render.templates[n]}else o=r[0].item(e).cloneNode(!0);for(var i=0;i<t[n].length;i++){var a=o.cloneNode(!0),d=t[n][i];domElement.setTextContent(a,d),l.appendChild(a)}render.templates[n]||(render.templates[n]=o,l.removeChild(r[0].item(e))),render.cache[n]=JSON.stringify(t[n])}}else render.isTypeOf("Object",t[n])?render.cache[n]!=JSON.stringify(t[n])&&(handleObject(e,n,t[n]),render.cache[n]=JSON.stringify(t[n])):render.isTypeOf("Function",t[n])||render.cache[n]!=JSON.stringify(t[n])&&(domElement.val(e,n,t[n]),render.cache[n]=JSON.stringify(t[n]))};var debounce=function(e,t){var n,r,t=t||250;return function(){var o=+new Date;n&&n+t>o?(clearTimeout(r),r=setTimeout(function(){n=o,e.apply(this,arguments)},t)):(n=o,e.apply(this,arguments))}};render.cache={};var mag=function(e,t,n,r){"use strict";var o={};o.init=function(e,t){if(!(this instanceof o.init))return new o.init(e,t);console.log("mag init")},o.prop=function(e){var r=function(){return arguments.length&&(e=arguments[0],n.redraw(t)),e};return r.toJSON=function(){return e},r},o.module=function(e,o,l){console.time("MagnumJS");var i=n.roots.indexOf(e);0>i&&(i=n.roots.length);var a=r.getElementById(e),d=a.parentNode,c=a.cloneNode(!0),s=r.createElement("span");d.replaceChild(s,a);var m=t.submodule(o,[l]);n.roots[i]=e;var u=new m.controller;t.controllers[i]=u,t.modules[i]=m,t.elements[i]=c,n.redraw(t),d.replaceChild(c,s),u.onload&&u.onload.call(),console.timeEnd("MagnumJS")};var l=function(e){return function(){return o[e].apply(this,arguments)}},i=l("init");return i.module=l("module"),i.prop=l("prop"),i}(mag=mag||{},mod,render,document);
