/*
Mag.JS v0.9.3
http://github.com/magnumjs/mag.js
(c) Michael Glazer
License: MIT
*/
!function(n,e,t,r){function o(n){return"[object Array]"===Object.prototype.toString.call(n)}function i(n){if(""!==n.id)return'id("'+n.id+'")';if(n===t.body)return n.tagName;var e=0;if(n.parentNode)for(var r=n.parentNode.childNodes,o=0;o<r.length;o++){var l=r[o];if(l===n)return i(n.parentNode)+"/"+n.tagName+"["+(e+1)+"]";1===l.nodeType&&l.tagName===n.tagName&&e++}}function l(n){var e=i(n);n.queryCache,n.parentNode.removeChild(n),p[e+"-config"]&&p[e+"-config"].configContext&&"function"==typeof p[e+"-config"].configContext.onunload&&p[e+"-config"].configContext.onunload(p[e+"-config"].configContext,n,p[e],e),delete p[e];for(var t in p)0===t.indexOf(e)&&delete p[t]}function a(n){return(n=n&&parseInt(n.split("[").pop().slice(0,-1)))?parseInt(n)-1:0}function c(n,e,t){var r,a,d;if(n){null==e&&(e={_text:""});var s=f(n);if(d=o(e)){if(y[t]&&0===s.length&&(y[t].parent.insertAdjacentHTML("beforeend",y[t].node),s=f(y[t].parent.children),"object"==typeof e[0]&&(e[0].MAGNUM=s[0].__key=0)),0===s.length)return;for(a=s[0].parentNode,y[t]||(y[t]={node:s[0].cloneNode(!0).outerHTML,parent:a}),w[t]=w[t]||0;s.length<e.length;)y[t]?(a.insertAdjacentHTML("beforeend",y[t].node),r=a.lastChild):r=s[0].cloneNode(!0),void 0!==e[w[t]]&&"object"==typeof e[w[t]]&&(e[w[t]][m]=w[t],r.__key=w[t]++),s.push(r),a&&a.appendChild(r);if(s.length>e.length)if(0==e.length||"object"!=typeof e[0])for(;s.length>e.length;)r=s.pop(),(a=r.parentNode)&&l(r);else var g=[],s=s.filter(function(n,t){return(void 0===n.__key&&0!=t&&void 0!==e[t]||e[t]&&void 0===e[t][m])&&(n.__key=t,e[t][m]=t),0==e.filter(function(e){return e[m]==n.__key}).length||!e[t]&&-1!==g.indexOf(n.__key)?(l(n),!1):(g.push(n.__key),!0)})}for(t=0;t<s.length;t++)r=i(s[t]),d?s[t]&&(p[r]&&p[r]===JSON.stringify(e[t]),c(s[t],e[t]),p[r]=JSON.stringify(e[t]),s[t].queryCache):u(s[t],e);return n}}function u(n,e){var t;if("function"!=typeof e){if("object"!=typeof e)return u(n,{_text:e});for(var a in e){var f=e[a];f===r?f="":null===f&&-1===["onunload"].indexOf(a)&&h(n,a).forEach(function(n){l(n)}),"_"===a[0]&&a!=m&&(t=t||{},t[a.substr(1)]=f)}var s=i(n);t&&d(n,t);var g=0;for(a in e)if(f=e[a],"_"!==a[0]){if(t=h(n,a),"function"==typeof f&&"fun"==f.type)try{f=f()}catch(v){}o(f)&&(t=h(n,"$"+a)),c(t,f,s+"/"+a),g++}}}function f(n){var e;if(null==n.length&&(n=[n]),!o(n)){e=[];for(var t=0;t<n.length;t+=1)n[t]&&e.push(n[t]);n=e}return n}function d(t,r){var o=i(t),l=a(o);p[o]&&p[o]===JSON.stringify(r),t._events=t._events||[];for(var c in r)if("text"!==c&&"html"!==c)if(0==c.indexOf("on")){if(-1===t._events.indexOf(c)||b){var u=function(e,t,r,o){try{return e.call(t,o,r,t)}finally{n.redraw()}}.bind(null,r[c],t,l);t[c]=u,t._events.push(c)}}else if("config"==c){u=!0,p[o+"-config"]?u=!1:p[o+"-config"]={};var f=p[o+"-config"].configContext=p[o+"-config"].configContext||{};e.push(function(n,e){return function(){return n.apply(n,e)}}(r[c],[t,u,f,l]))}else u={key:c,cache:!1,value:r[c],node:t},n.hook("attributes",c,u),u.change&&(c=u.key,r[c]=u.value),null===r[c]?t.removeAttribute(c):t.setAttribute(c,""+r[c]);s(t,r.text),g(t,r.html),t.queryCache}function s(n,e){var t,r;if(i(n),n&&null!=e){if(!r){r=[];for(var o=0;o<n.childNodes.length;o+=1)t=n.childNodes[o],t.nodeType===v&&r.push(t)}for(;n.firstChild;)n.removeChild(n.firstChild);for("input"===n.nodeName.toLowerCase()?n.setAttribute("value",""+e):n.appendChild(n.ownerDocument.createTextNode(""+e)),o=0;o<r.length;o+=1)n.appendChild(r[o])}}function g(n,e){n&&null!=e&&(n.innerHTML=e)}function h(n,e,t){for(var r=n.childNodes,o=[],i=0;i<r.length;i+=1)r[i].nodeType===v&&o.push(r[i]);if(r=[],i=e,!n.queryCache||!n.queryCache[e]||"$"===e[0]){n="$"===e[0],"$"===i[0]&&(i=i.substr(1));for(var l=0;l<o.length;l+=1){var a=o[l],c=i,u=" "+a.className+" ";(a.id===c||-1<u.indexOf(" "+c+" ")||a.name===c||a.nodeName.toLowerCase()===c.toLowerCase()||a.getAttribute("data-bind")===c)&&r.push(o[l])}if(!r.length||n)for(l=0;l<o.length&&(r=r.concat(h(o[l],e,!0)),!r.length||n);l++);return!t&&!r.length,r}return n.queryCache[e]}var v=1,p=[],m="__magnum__",y={},p=[],w={},b=!1;n.fill={fill:c,find:h,clear:function(){b=!0},unclear:function(){b=!1},configs:e},window.mag=n}(window.mag||{},[],document),function(n){var e={modules:[],promises:[],deferreds:[],controllers:[],elements:[],getController:function(n,e,t){return"undefined"!=typeof Proxy?new Proxy(new n.controller,{get:function(n,r){if(void 0===n[r]&&-1===["watchers","toJSON","called","onload","onunload"].indexOf(r)){var o,i=t.find(e,r),l="$"===r[0],a=[];return i.forEach(function(n,e){i[e]&&(i[e].value&&0<i[e].value.length?(o=i[e].value,!i[e].type||"checkbox"!=i[e].type&&"radio"!=i[e].type||(o={_text:o,_checked:i[e].checked},a.push(o))):i[e].innerText&&0<i[e].innerText.length?o=i[e].innerText:i[0].innerHTML&&0<i[e].innerHTML.length&&(o=i[e].innerHTML))}),0<a.length&&l?a:o}return n[r]}}):new n.controller},submodule:function(n,e){var t=function(e){return(n.controller||function(){}).apply(this,e)}.bind({},e);return t.$original=n.controller,t={controller:t,view:function(t){if(1<arguments.length)var r=e.concat([].slice.call(arguments,1));r=n.view.apply(n,r?[t].concat(r):[t]),e[0]&&null!=e[0].key&&(r.attrs.key=e[0].key)}},e[0]&&null!=e[0].key&&(t.attrs={key:e[0].key}),t},getArgs:function(n){return e.modules[n].controller&&e.modules[n].controller.$$args?[e.controllers[n]].concat(e.modules[n].controller.$$args):[e.controllers[n]]}};n.mod=e}(window.mag||{}),function(n){function e(n,e,t){var o=(e.getArgs(t),e.modules[t]);e=e.controllers[t];var i=r.contexts[t]=r.contexts[t]||{};try{o.view(e,n,i)}catch(l){console.log(n.id,t,l)}}function t(n,e){n&&void 0!==Object.observe&&Object.observe(n,function(r){r.forEach(function(r){"object"==typeof n[r.name]&&t(n[r.name],e)}),e.apply(this,arguments)})}var r={roots:[],contexts:[],templates:{},cache:{},callOnload:function(n){for(var e,t=0;e=n.controllers[t];t++)e.onload&&!e.called&&(e.onload.call(null,n.elements[t]),e.called=1)},callConfigs:function(n){for(var e=0,t=n.length;t>e;e++)n[e]()}},o=[];r.redraw=function(n,e,t){n=n||r.module||{},this.fun=this.fun||c(function(){e.configs.splice(0,e.configs.length),r.doLoop(n,e,t)}),this.fun()},r.doLoop=function(e,t,o){for(var i=0;r.roots[i];i++)if(n.running=!0,e.controllers[i]&&r.innerLoop(e,t,i,o)&&(e.deferreds[i][2]({_html:e.elements[i].innerHTML}),e.deferreds[i][0])){var l=e.deferreds[i][1];delete e.elements[l],e.modules[l],e.controllers[l],e.promises[l],e.deferreds[l]}t.unclear()},r.clear=function(n,e,t){-1!==n&&o[n]&&t.clear()},r.innerLoop=function(n,t,i,l){var a=n.elements[i],c=n.getArgs(i);return o[i]&&o[i]===JSON.stringify(c[0])?!1:(e(a,n,i),o[i]=JSON.stringify(c[0]),r.setupWatch(l,c,t,a,i,n),t.fill(a,c[0]),r.callConfigs(t.configs),r.callOnload(n),!0)};var i;r.doWatch=function(t,l,a,c,u,f){f!=i&&(i=f,n.running=!0,u=c.getArgs(a),o[a]&&o[a]===JSON.stringify(u[0])||(e(l,c,a),o[a]=JSON.stringify(u[0]),t.fill(l,u[0]),r.callConfigs(t.configs),n.running=!1))},r.setupWatch=function(n,e,o,i,l,a){t(e[0],function(n){c(r.doWatch.bind({},o,i,l,a,n))()})};var l=window.cancelAnimationFrame||window.clearTimeout,a=window.requestAnimationFrame||window.setTimeout,c=function(n,e){var t,r,o=e||16;return function(){if(+new Date-t>o||a===window.requestAnimationFrame){r>0&&l(r);var e=arguments;r=a(function(){t=+new Date;var r=[].slice.call(arguments).concat([].slice.call(e));n.apply(this,r)},o)}else{t=+new Date;var i=[].slice.call(arguments).concat([].slice.call(e));n.apply(this,i),r=a(function(){r=null},o)}}};n.render=r}(window.mag||{}),function(n,e){function t(e){var t=function(){return arguments.length&&(e=arguments[0],n.redraw()),e};return t.type="fun",t.toJSON=function(){return e},t}function r(e,t){var o=n.prop(t);return e.then(o),o.then=function(n,o){return r(e.then(n,o),t)},o}var o=n.mod,i=n.render,l=n.fill,a=n.watch,c={}.toString,u=n.running=!1;n.redraw=function(){u||(u=!0,i.redraw(o||i.module||{},l,a),u=!1)},n.withProp=function(n,e){return function(t){t=t||event,t=t.currentTarget||this,e(n in t?t[n]:t.getAttribute(n))}},n.prop=function(n){return(null!=n&&"[object Object]"===c.call(n)||"function"==typeof n)&&"function"==typeof n.then?r(n):t(n)};var f={attributes:[]};n.hookin=function(n,e,t){f[n].push({context:{},handler:t,key:e})},n.hook=function(n,e,t,r){for(var o in f[n])t.changed=!1,f[n][o].key==e&&(r=JSON.stringify({v:t.value,k:t.key}),f[n][o].handler.call(f[n][o].context,t),r!==JSON.stringify({v:t.value,k:t.key})&&(t.change=!0))};var d=[];n.module=function(t,a,c,u){var f=i.roots.indexOf(t);c&&!c.retain&&i.clear(f,t,l),(0>f||u)&&(f=i.roots.length);for(var s,g=!1,h={preventDefault:function(){g=!0}},v=0;s=d[v];v++)s.handler(h),s.controller.onunload=null;if(g)for(v=0;s=d[v];v++)s.controller.onunload=s.handler;else d=[];return g?void 0:(t=e.getElementById(t))?(i.roots[f]=t.id,a.view?(a=o.submodule(a,[Object.freeze(c||{})]),c=o.getController(a,t,l),o.controllers[f]=c,c.onunload&&d.push({controller:c,handler:c.onunload}),o.modules[f]=a,o.elements[f]=u?t.cloneNode(!0):t,o.promises[f]=new Promise(function(){o.deferreds[f]=arguments}.bind(null,u,f)),n.redraw(),c.onload&&!n.running&&i.callOnload(o),r(o.promises[f],{_html:o.elements[f].innerHTML})):Error("module requires a view")):Error("invalid node")}}(window.mag||{},document);
