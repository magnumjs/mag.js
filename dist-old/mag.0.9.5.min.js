/*
Mag.JS v0.9.5
http://github.com/magnumjs/mag.js
(c) Michael Glazer
License: MIT
*/
!function(n,e,t,r){function o(n){return"[object Array]"===Object.prototype.toString.call(n)}function i(n){if(""!==n.id)return'id("'+n.id+'")';if(n===t.body)return n.tagName;var e=0;if(n.parentNode)for(var r=n.parentNode.childNodes,o=0;o<r.length;o++){var l=r[o];if(l===n)return i(n.parentNode)+"/"+n.tagName+"["+(e+1)+"]";1===l.nodeType&&l.tagName===n.tagName&&e++}}function l(n){var e=i(n);n.queryCache,n.parentNode.removeChild(n),p[e+"-config"]&&p[e+"-config"].configContext&&"function"==typeof p[e+"-config"].configContext.onunload&&p[e+"-config"].configContext.onunload(p[e+"-config"].configContext,n,p[e],e),delete p[e];for(var t in p)0===t.indexOf(e)&&delete p[t]}function a(n){return(n=n&&parseInt(n.split("[").pop().slice(0,-1)))?parseInt(n)-1:0}function c(n,e,t){var a,d,s;if(n){null==e&&(e={_text:""});var g=f(n);if(s=o(e)){if(w[t]=w[t]||0,y[t]&&0===g.length&&(y[t].parent.insertAdjacentHTML("beforeend",y[t].node),g=f(y[t].parent.children),"object"==typeof e[0]),0===g.length)return;for(d=g[0].parentNode,y[t]||(y[t]={node:g[0].cloneNode(!0).outerHTML,parent:d});g.length<e.length;)y[t]?(d.insertAdjacentHTML("beforeend",y[t].node),a=d.lastChild):a=g[0].cloneNode(!0),g.push(a),d&&d.appendChild(a);if(void 0===g[0].__key&&"object"==typeof e[0],a=e.map(function(n){return n[m]}),(g.length==e.length||-1!==a.indexOf(r))&&(e=e.map(function(n,e){return"object"==typeof n&&(void 0===n[m]&&(n[m]="__magnum__"+w[t]++),g[e].__key=n[m]),n})),g.length>e.length)if(0===e.length||"object"!=typeof e[0])for(;g.length>e.length;)a=g.pop(),(d=a.parentNode)&&l(a);else var h=e.map(function(n){return n[m]}),g=(g.map(function(n){return n.__key}),g.filter(function(n){return-1===h.indexOf(n.__key)?(l(n),!1):!0}))}for(a=0;a<g.length;a++)d=i(g[a]),s?g[a]&&(p[d]&&p[d]===JSON.stringify(e[a]),c(g[a],e[a]),p[d]=JSON.stringify(e[a]),g[a].queryCache):u(g[a],e);return n}}function u(n,e){var t;if("function"!=typeof e){if("object"!=typeof e)return u(n,{_text:e});for(var a in e){var f=e[a];f===r?f="":null===f&&-1===["onunload"].indexOf(a)&&h(n,a).forEach(function(n){l(n)}),"_"===a[0]&&(t=t||{},t[a.substr(1)]=f)}var s=i(n);t&&d(n,t);var g=0;for(a in e)if(f=e[a],"_"!==a[0]){if(t=h(n,a),"function"==typeof f&&"fun"==f.type)try{f=f()}catch(v){}o(f)&&(t=h(n,"$"+a)),c(t,f,s+"/"+a),g++}}}function f(n){var e;if(null==n.length&&(n=[n]),!o(n)){e=[];for(var t=0;t<n.length;t+=1)n[t]&&e.push(n[t]);n=e}return n}function d(t,r){var o=i(t),l=a(o);p[o]&&p[o]===JSON.stringify(r),t._events=t._events||[];for(var c in r)if("text"!==c&&"html"!==c)if(0==c.indexOf("on")){if(-1===t._events.indexOf(c)||b){var u=function(e,t,r,o){try{return e.call(t,o,r,t)}finally{n.redraw()}}.bind(null,r[c],t,l);t[c]=u,t._events.push(c)}}else if("config"==c){u=!0,p[o+"-config"]?u=!1:p[o+"-config"]={};var f=p[o+"-config"].configContext=p[o+"-config"].configContext||{};e.push(function(n,e){return function(){return n.apply(n,e)}}(r[c],[t,u,f,l]))}else u={key:c,cache:!1,value:r[c],node:t},n.hook("attributes",c,u),u.change&&(c=u.key,r[c]=u.value),null===r[c]?t.removeAttribute(c):t.setAttribute(c,""+r[c]);s(t,r.text),g(t,r.html),t.queryCache}function s(n,e){var t,r;if(i(n),n&&null!=e){if(!r){r=[];for(var o=0;o<n.childNodes.length;o+=1)t=n.childNodes[o],t.nodeType===v&&r.push(t)}for(;n.firstChild;)n.removeChild(n.firstChild);for("input"===n.nodeName.toLowerCase()?n.setAttribute("value",""+e):n.appendChild(n.ownerDocument.createTextNode(""+e)),o=0;o<r.length;o+=1)n.appendChild(r[o])}}function g(n,e){n&&null!=e&&(n.innerHTML=e)}function h(n,e,t){var r=n.childNodes;n=[];for(var o=0;o<r.length;o+=1)r[o].nodeType===v&&n.push(r[o]);var r=[],o=e,i="$"===e[0];"$"===o[0]&&(o=o.substr(1));for(var l=0;l<n.length;l+=1){var a=n[l],c=o,u=" "+a.className+" ";(a.id===c||-1<u.indexOf(" "+c+" ")||a.name===c||a.nodeName.toLowerCase()===c.toLowerCase()||a.getAttribute("data-bind")===c)&&r.push(n[l])}if(!r.length||i)for(l=0;l<n.length&&(r=r.concat(h(n[l],e,!0)),!r.length||i);l++);return!t&&!r.length,r}var v=1,p=[],m="_key",y={},p=[],w={},b=!1;n.fill={fill:c,find:h,clear:function(){b=!0},unclear:function(){b=!1},configs:e},window.mag=n}(window.mag||{},[],document),function(n){var e={modules:[],promises:[],deferreds:[],controllers:[],elements:[],getController:function(n,e,t){return"undefined"!=typeof Proxy?new Proxy(new n.controller,{get:function(n,r){if(void 0===n[r]&&-1===["watchers","toJSON","called","onload","onunload"].indexOf(r)){var o,i=t.find(e,r),l="$"===r[0],a=[];return i.forEach(function(n,e){i[e]&&(i[e].value&&0<i[e].value.length?(o=i[e].value,!i[e].type||"checkbox"!=i[e].type&&"radio"!=i[e].type||(o={_text:o,_checked:i[e].checked},a.push(o))):i[e].innerText&&0<i[e].innerText.length?o=i[e].innerText:i[0].innerHTML&&0<i[e].innerHTML.length&&(o=i[e].innerHTML))}),0<a.length&&l?a:o}return n[r]}}):new n.controller},submodule:function(n,e){var t=function(e){return(n.controller||function(){}).apply(this,e)}.bind({},e);return t.$original=n.controller,t={controller:t,view:function(t){if(1<arguments.length)var r=e.concat([].slice.call(arguments,1));r=n.view.apply(n,r?[t].concat(r):[t]),e[0]&&null!=e[0].key&&(r.attrs.key=e[0].key)}},e[0]&&null!=e[0].key&&(t.attrs={key:e[0].key}),t},getArgs:function(n){return e.modules[n].controller&&e.modules[n].controller.$$args?[e.controllers[n]].concat(e.modules[n].controller.$$args):[e.controllers[n]]}};n.mod=e}(window.mag||{}),function(n){function e(n,e,t){var o=(e.getArgs(t),e.modules[t]);e=e.controllers[t];var i=r.contexts[t]=r.contexts[t]||{};try{o.view(e,n,i)}catch(l){console.log(n.id,t,l)}}function t(n,e){n&&void 0!==Object.observe&&Object.observe(n,function(r){r.forEach(function(r){"object"==typeof n[r.name]&&t(n[r.name],e)}),e.apply(this,arguments)})}var r={roots:[],contexts:[],templates:{},cache:{},callLCEvent:function(n,e,t,r){e.controllers[t][n]&&(e.controllers[t][n].call({},e.elements[t]),r&&(e.controllers[t][n]=0))},callConfigs:function(n){for(var e=0,t=n.length;t>e;e++)n[e]()}},o=[];r.redraw=function(n,e){n=n||r.module||{},this.fun=this.fun||c(function(){e.configs.splice(0,e.configs.length),r.doLoop(n,e)}),this.fun()},r.doLoop=function(e,t){for(var o=0;r.roots[o];o++)if(n.running=!0,e.controllers[o]&&e.elements[o])if(r.callLCEvent("willload",e,o,1),r.innerLoop(e,t,o)){if(e.deferreds[o][2]({_html:e.elements[o].innerHTML}),r.callConfigs(t.configs),e.deferreds[o][0]){var i=e.deferreds[o][1];delete e.elements[i],e.modules[i],e.controllers[i],e.promises[i],e.deferreds[i]}}else r.callLCEvent("didload",e,o,1);t.unclear()},r.clear=function(n,e,t){-1!==n&&o[n]&&t.clear()},r.innerLoop=function(n,t,i){var l=n.elements[i],a=n.getArgs(i);return o[i]&&o[i]===JSON.stringify(a[0])?!1:(e(l,n,i),o[i]=JSON.stringify(a[0]),r.setupWatch(a,t,l,i,n),t.fill(l,a[0]),!0)};var i;r.doWatch=function(t,l,a,c,u,f){if(f!=i){if(i=f,n.running=!0,r.callLCEvent("willupdate",c,a,1),u=c.getArgs(a),o[a]&&o[a]===JSON.stringify(u[0]))return void r.callLCEvent("didupdate",c,a);e(l,c,a),o[a]=JSON.stringify(u[0]),t.fill(l,u[0]),n.running=!1}},r.setupWatch=function(n,e,o,i,l){t(n[0],function(n){c(r.doWatch.bind({},e,o,i,l,n))()})};var l=window.cancelAnimationFrame||window.clearTimeout,a=window.requestAnimationFrame||window.setTimeout,c=function(n,e){var t,r,o=e||16;return function(){if(+new Date-t>o||a===window.requestAnimationFrame){r>0&&l(r);var e=arguments;r=a(function(){t=+new Date;var r=[].slice.call(arguments).concat([].slice.call(e));n.apply(this,r)},o)}else{t=+new Date;var i=[].slice.call(arguments).concat([].slice.call(e));n.apply(this,i),r=a(function(){r=null},o)}}};n.render=r}(window.mag||{}),function(n,e){function t(e){var t=function(){return arguments.length&&(e=arguments[0],n.redraw()),e};return t.type="fun",t.toJSON=function(){return e},t}function r(e,t){var o=n.prop(t);return e.then(o),o.then=function(n,o){return r(e.then(n,o),t)},o}function o(n){for(var e,t=!1,r={preventDefault:function(){t=!0}},o=0;e=s[o];o++);if(t)for(o=0;e=s[o];o++)e.controller.onunload=e.handler;else s=[];return i.controllers[n]&&typeof i.controllers[n].onunload===u&&(i.controllers[n].onunload(r),i.controllers[n].onunload=0),t}var i=n.mod,l=n.render,a=n.fill,c={}.toString,u="function",f=n.running=!1;n.redraw=function(){f||(f=!0,l.redraw(i||l.module||{},a),f=!1)},n.withProp=function(n,e){return function(t){t=t||event,t=t.currentTarget||this,e(n in t?t[n]:t.getAttribute(n))}},n.prop=function(n){return(null!=n&&"[object Object]"===c.call(n)||typeof n===u)&&typeof n.then===u?r(n):t(n)};var d={attributes:[]};n.hookin=function(n,e,t){d[n].push({context:{},handler:t,key:e})},n.hook=function(n,e,t,r){for(var o in d[n])t.changed=!1,d[n][o].key==e&&(r=JSON.stringify({v:t.value,k:t.key}),d[n][o].handler.call(d[n][o].context,t),r!==JSON.stringify({v:t.value,k:t.key})&&(t.change=!0))};var s=[];n.module=function(t,c,u,f){var d=l.roots.indexOf(t);return d>-1&&o(d)?void 0:(u&&!u.retain&&l.clear(d,t,a),(0>d||f)&&(d=l.roots.length),(t=e.getElementById(t))?(l.roots[d]=t.id,c.view?(c=i.submodule(c,[Object.freeze(u||{})]),u=i.getController(c,t,a),i.controllers[d]=u,u.onunload&&s.push({controller:u,handler:u.onunload}),i.modules[d]=c,i.elements[d]=f?t.cloneNode(!0):t,i.promises[d]=new Promise(function(){i.deferreds[d]=arguments}.bind({},f,d)),n.redraw(),r(i.promises[d],{_html:i.elements[d].innerHTML})):Error("Mag.JS module - requires a view")):Error("Mag.JS Module - invalid node"))}}(window.mag||{},document);
