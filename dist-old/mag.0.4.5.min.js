/*
* MagnumJS - By Michael Glazer March 2015
* https://github.com/magnumjs/mag.js
*/
var mag=function(e,n,t,r){function o(e){return"[object Array]"===Object.prototype.toString.call(e)}function i(e){"function"==typeof a.logger&&a.logger(e)}function a(e,n,t,r){var i,u,s;if(e){null==n&&(n={_text:""});var f=c(e);if(s=o(n)){if(v[t+r]&&0===f.length&&(v[t+r].parent.insertAdjacentHTML("beforeend",v[t+r].node),f=c(v[t+r].parent.children)),0===f.length)return;for(u=f[0].parentNode,v[t+r]||(v[t+r]={node:f[0].cloneNode(!0).outerHTML,parent:u},u.removeChild(f[0]));f.length<n.length;)v[t+r]?(u.insertAdjacentHTML("beforeend",v[t+r].node),i=u.lastChild):i=f[0].cloneNode(!0),f.push(i),u&&u.appendChild(i);for(;f.length>n.length;)i=f.pop(),u=i.parentNode,u&&u.removeChild(i)}for(var h=0;h<f.length;h++)s?f[h]&&a(f[h],n[h]):l(f[h],n);return e}}function l(e,n){var t,o;if("function"!=typeof n){if("object"!=typeof n)return l(e,{_text:n});for(var i in n){var c=n[i];c===r&&(c=""),"_"===i[0]&&(t=t||{},t[i.substr(1)]=c)}t&&u(e,t);var s=0;for(var i in n){var c=n[i];if("_"!==i[0]){if(o=h(e,i),"function"==typeof c&&"fun"==c.type)try{c=c()}catch(f){}a(o,c,i,s),s++}}}}function c(e){var n;if(null==e.length&&(e=[e]),!o(e)){n=[];for(var t=0;t<e.length;t+=1)e[t]&&n.push(e[t]);e=n}return e}function u(e,t){s(e,t.text),f(e,t.html),e._events=e._events||[];for(var r in t)if("text"!==r&&"html"!==r)if(0==r.indexOf("on")){if(-1!==e._events.indexOf(r))continue;e.addEventListener(r.substr(2),t[r]),e._events.push(r)}else{if("config"==r){var o=!0,i=function(e,n){return function(){return e.apply(e,n)}};n.push(i(t[r],[e,o]));continue}null===t[r]?e.removeAttribute(r):e.setAttribute(r,""+t[r])}}function s(e,n){var t,r;if(e&&null!=n){if(!r){r=[];for(var o=0;o<e.childNodes.length;o+=1)t=e.childNodes[o],t.nodeType===g&&r.push(t)}for(;e.firstChild;)e.removeChild(e.firstChild);"input"===e.nodeName.toLowerCase()?e.setAttribute("value",""+n):e.appendChild(e.ownerDocument.createTextNode(""+n));for(var o=0;o<r.length;o+=1)e.appendChild(r[o])}}function f(e,n){e&&null!=n&&(e.innerHTML=n)}function h(e,n,t){var r=d(e),o=[],a=n;if(!(e.queryCache||{})[n]){e.queryCache=(e.queryCache||{})[n]=[];var l="$"===n[0];"$"===a[0]&&(a=a.substr(1));for(var c=0;c<r.length;c+=1)p(r[c],a)&&o.push(r[c]);if(!o.length||l)for(var c=0;c<r.length&&(o=o.concat(h(r[c],n,!0)),!o.length||l);c++);t||o.length||i('FILL - Warning: no matches found for "'+n+'"'),e.queryCache[n]=o}return e.queryCache[n]}function d(e){for(var n=e.childNodes,t=[],r=0;r<n.length;r+=1)n[r].nodeType===g&&t.push(n[r]);return t}function p(e,n){var t=" "+e.className+" ";return e.id===n||t.indexOf(" "+n+" ")>-1||e.name===n||e.nodeName.toLowerCase()===n.toLowerCase()||e.getAttribute("data-bind")===n}var g=1,v={};return e.fill={fill:a,configs:n},e}(window.mag||{},[],document),mag=function(e){function n(){O=null;for(var e=0;e<j.length;e++)j[e]();j.length=0}var t={noMore:!1,useDirtyCheck:!1},r=[],o=[],i=[],a=!1;try{a=Object.defineProperty&&Object.defineProperty({},"x",{})}catch(l){}var c=function(e){var n={};return e&&"[object Function]"==n.toString.call(e)},u=function(e){return"[object Array]"===Object.prototype.toString.call(e)},s=function(e){return"[object Object]"==={}.toString.apply(e)},f=function(e){if(null==e||"object"!=typeof e)return e;var n=e.constructor();for(var t in e)n[t]=e[t];return n},h=function(e,n,t,r){try{Object.observe(e,function(e){e.forEach(function(e){e.name===n&&r(e.object[e.name])})})}catch(o){try{Object.defineProperty(e,n,{get:t,set:function(e){r.call(this,e,!0)},enumerable:!0,configurable:!0})}catch(i){try{Object.prototype.__defineGetter__.call(e,n,t),Object.prototype.__defineSetter__.call(e,n,function(e){r.call(this,e,!0)})}catch(a){p(e,n,r)}}}},d=function(e,n,t){try{Object.defineProperty(e,n,{enumerable:!1,configurable:!0,writable:!1,value:t})}catch(r){e[n]=t}},p=function(e,n,t){o[o.length]={prop:n,object:e,orig:f(e[n]),callback:t}},g=function(){c(arguments[1])?v.apply(this,arguments):u(arguments[1])?m.apply(this,arguments):w.apply(this,arguments)},v=function(e,n,t,r){if("string"!=typeof e&&(e instanceof Object||u(e))){if(u(e)){if(T(e,"__watchall__",n,t),void 0===t||t>0)for(var o=0;o<e.length;o++)v(e[o],n,t,r)}else{var o,i=[];for(o in e)"$val"==o||!a&&"watchers"===o||Object.prototype.hasOwnProperty.call(e,o)&&i.push(o);m(e,i,n,t,r)}r&&I(e,"$$watchlengthsubjectroot",n,t)}},m=function(e,n,t,r,o){if("string"!=typeof e&&(e instanceof Object||u(e)))for(var i=0;i<n.length;i++){var a=n[i];w(e,a,t,r,o)}},w=function(e,n,t,r,o){"string"!=typeof e&&(e instanceof Object||u(e))&&(c(e[n])||(null==e[n]||void 0!==r&&0>=r||v(e[n],t,void 0!==r?r-1:r),T(e,n,t,r),o&&(void 0===r||r>0)&&I(e,n,t,r)))},y=function(){c(arguments[1])?_.apply(this,arguments):u(arguments[1])?b.apply(this,arguments):P.apply(this,arguments)},_=function(e,n){if(!(e instanceof String)&&(e instanceof Object||u(e)))if(u(e)){for(var t=["__watchall__"],r=0;r<e.length;r++)t.push(r);b(e,t,n)}else{var o=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&(e[r]instanceof Object?o(e[r]):t.push(r));b(e,t,n)};o(e)}},b=function(e,n,t){for(var r in n)n.hasOwnProperty(r)&&P(e,n[r],t)},j=[],O=null,C=function(){return O||(O=setTimeout(n)),O},N=function(e){null==O&&C(),j[j.length]=e},S=function(){var e=c(arguments[2])?M:A;e.apply(this,arguments)},A=function(e,n,t,r){var o,i=null,a=-1,l=u(e),c=function(t,r,o,c){var u=C();if(a!==u&&(a=u,i={type:"update"},i.value=e,i.splices=null,N(function(){n.call(this,i),i=null})),l&&e===this&&null!==i){if("pop"===r||"shift"===r)o=[],c=[c];else if("push"===r||"unshift"===r)o=[o],c=[];else if("splice"!==r)return;i.splices||(i.splices=[]),i.splices[i.splices.length]={index:t,deleteCount:c?c.length:0,addedCount:o?o.length:0,added:o,deleted:c}}};o=1==t?void 0:0,v(e,c,o,r)},M=function(e,n,t,r,o){e&&n&&(w(e,n,function(e,n,i,a){var l={type:"update"};l.value=i,l.oldvalue=a,(r&&s(i)||u(i))&&A(i,t,r,o),t.call(this,l)},0),(r&&s(e[n])||u(e[n]))&&A(e[n],t,r,o))},T=function(e,n,r,o){var i=!1,a=u(e);e.watchers||(d(e,"watchers",{}),a&&L(e,function(t,r,i,a){if(F(e,t,r,i,a),0!==o&&i&&(s(i)||u(i))){var l,c,f,h,d=e.watchers[n];for((h=e.watchers.__watchall__)&&(d=d?d.concat(h):h),f=d?d.length:0,l=0;f>l;l++)if("splice"!==r)v(i,d[l],void 0===o?o:o-1);else for(c=0;c<i.length;c++)v(i[c],d[l],void 0===o?o:o-1)}})),e.watchers[n]||(e.watchers[n]=[],a||(i=!0));for(var l=0;l<e.watchers[n].length;l++)if(e.watchers[n][l]===r)return;if(e.watchers[n].push(r),i){var c=e[n],f=function(){return c},g=function(r,i){var a=c;if(c=r,0!==o&&e[n]&&(s(e[n])||u(e[n]))&&!e[n].watchers){var l,f=e.watchers[n].length;for(l=0;f>l;l++)v(e[n],e.watchers[n][l],void 0===o?o:o-1)}return E(e,n)?void q(e,n):void(t.noMore||a!==r&&(i?F(e,n,"set",r,a):J(e,n,"set",r,a),t.noMore=!1))};t.useDirtyCheck?p(e,n,g):h(e,n,f,g)}},J=function(e,n,t,r,o){if(void 0!==n){var i,a,l=e.watchers[n];(a=e.watchers.__watchall__)&&(l=l?l.concat(a):a),i=l?l.length:0;for(var c=0;i>c;c++)l[c].call(e,n,t,r,o)}else for(var n in e)e.hasOwnProperty(n)&&J(e,n,t,r,o)},$=["pop","push","reverse","shift","sort","slice","unshift","splice"],x=function(e,n,t,r){d(e,t,function(){var o,i,a,l,c=0;if("splice"===t){var u=arguments[0],s=u+arguments[1];for(a=e.slice(u,s),i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];c=u}else i=arguments.length>0?arguments[0]:void 0;return l=n.apply(e,arguments),"slice"!==t&&("pop"===t?(a=l,c=e.length):"push"===t?c=e.length-1:"shift"===t?a=l:"unshift"!==t&&void 0===i&&(i=l),r.call(e,c,t,i,a)),l})},L=function(e,n){if(c(n)&&e&&!(e instanceof String)&&u(e))for(var t,r=$.length;r--;)t=$[r],x(e,e[t],t,n)},P=function(e,n,t){if(e.watchers[n])if(void 0===t)delete e.watchers[n];else for(var r=0;r<e.watchers[n].length;r++){var o=e.watchers[n][r];o==t&&e.watchers[n].splice(r,1)}W(e,n,t),B(e,n)},k=function(e,n){if(e.watchers){var t="__wjs_suspend__"+(void 0!==n?n:"");e.watchers[t]=!0}},E=function(e,n){return e.watchers&&(e.watchers.__wjs_suspend__||e.watchers["__wjs_suspend__"+n])},q=function(e,n){N(function(){delete e.watchers.__wjs_suspend__,delete e.watchers["__wjs_suspend__"+n]})},D=null,F=function(e,n,t,r,o){i[i.length]={obj:e,prop:n,mode:t,newval:r,oldval:o},null===D&&(D=setTimeout(H))},H=function(){var e=null;D=null;for(var n=0;n<i.length;n++)e=i[n],J(e.obj,e.prop,e.mode,e.newval,e.oldval);e&&(i=[],e=null)},I=function(e,n,t,o){var i;i=f("$$watchlengthsubjectroot"===n?e:e[n]),r.push({obj:e,prop:n,actual:i,watcher:t,level:o})},W=function(e,n,t){for(var o=0;o<r.length;o++){var i=r[o];i.obj==e&&i.prop==n&&i.watcher==t&&r.splice(o,1)}},B=function(e,n){for(var t,r=0;r<o.length;r++){var i=o[r],a=i.object.watchers;t=i.object==e&&i.prop==n&&a&&(!a[n]||0==a[n].length),t&&o.splice(r,1)}};return t.watch=g,t.unwatch=y,t.callWatchers=J,t.suspend=k,t.onChange=S,e.watch=t,e}(window.mag||{}),mag=function(e){var n={modules:[],controllers:[],elements:[]};return n.submodule=function(e,n){var t=function(n){return(e.controller||function(){}).apply(this,n)}.bind({},n),r=function(t){arguments.length>1&&(n=n.concat([].slice.call(arguments,1)));var r=e.view.apply(e,n?[t].concat(n):[t]);return n[0]&&null!=n[0].key&&(r.attrs.key=n[0].key),r};t.$original=e.controller;var o={controller:t,view:r};return n[0]&&null!=n[0].key&&(o.attrs={key:n[0].key}),o},n.getArgs=function(e){var t=n.modules[e].controller&&n.modules[e].controller.$$args?[n.controllers[e]].concat(n.modules[e].controller.$$args):[n.controllers[e]];return t},e.mod=n,e}(window.mag||{}),mag=function(e){function n(e,n,t){var r=(n.getArgs(t),n.modules[t]),o=n.controllers[t];r.view(e,o)}var t={roots:[],templates:{},cache:{}};t.callConfigs=function(e){for(var n=0,t=e.length;t>n;n++)e[n]()};var r=[];t.redraw=function(e,o,i){e=e||t.module||{},this.fun||(this.fun=a(function(){o.configs.splice(0,o.configs.length);for(var l in t.roots){{t.roots[l]}if(e.controllers[l]){var c="__"+new Date+"__",u=e.elements[l];if(c in u)continue;console.time("Mag.JS:render:"+u.id);var s=e.getArgs(l);if(r[l]&&r[l]===JSON.stringify(s[0]))continue;n(u,e,l),i.watch(s[0],a(function(e,a,l){console.time("Mag.JS:re-render:"+e.id);var c=l.getArgs(a);r[a]!==JSON.stringify(c[0])&&(n(e,l,a),o.fill(e,c[0]),i.noMore=!0,t.callConfigs(o.configs)),console.timeEnd("Mag.JS:re-render:"+e.id)}.bind(null,u,l,e))),o.fill(u,s[0]),t.callConfigs(o.configs),r[l]=JSON.stringify(s[0]),delete u[c],console.timeEnd("Mag.JS:render:"+u.id)}}})),this.fun()};var o=window.cancelAnimationFrame||window.clearTimeout,i=window.requestAnimationFrame||window.setTimeout,a=function(e,n){var t,r,a=n||16;return function(){+new Date-t>a||i===window.requestAnimationFrame?(r>0&&o(r),r=i(function(){t=+new Date,e.apply(this,arguments)},a)):(t=+new Date,e.apply(this,arguments))}};return e.render=t,e}(window.mag||{}),mag=function(e,n){var t,r={},o=e.mod,i=e.render,a=e.fill,l=mag.watch;r.init=function(){};var c=!1;r.redraw=function(){return c?void console.log("test"):(c=!0,i.redraw(o||i.module||{},a,l),void(c=!1))},r.withProp=function(e,n){return function(t){t=t||event;var r=t.currentTarget||this;n(e in r?r[e]:r.getAttribute(e))}},r.prop=function(e){var n=function(){return arguments.length&&(e=arguments[0],r.redraw()),e};return n.type="fun",n.toJSON=function(){return JSON.parse(JSON.stringify(e))},n};r.module=function(e,a,l,c){console.time("MagnumJS:init");var u=i.roots.indexOf(e);0>u&&(u=i.roots.length);var s=n.getElementById(e);if(!s)return Error("invalid node");var f=s.parentNode,h=s.cloneNode(!0),d=n.createElement("span");if(f.replaceChild(d,s),a.view){var p=o.submodule(a,[l]);i.roots[u]=h.id;var g=t=p=p||{},v=p.controller||function(){},m=new v;return g===t&&(o.controllers[u]=m,o.modules[u]=p,o.elements[u]=h),r.redraw(),f.replaceChild(h,d),m.onload&&m.onload.call(null,h),console.timeEnd("MagnumJS:init"),{_html:h.innerHTML}}};var u=function(e){return function(){return r[e].apply(this,arguments)}},s=u("init");return s.module=u("module"),s.prop=u("prop"),s.redraw=u("redraw"),s.withProp=u("withProp"),s}(window.mag||{},document);
