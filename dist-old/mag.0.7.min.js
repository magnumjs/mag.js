/*
Mag.JS v0.7
http://github.com/magnumjs/mag.js
(c) Michael Glazer
License: MIT
*/
!function(n,t,e,r){function o(n){return"[object Array]"===Object.prototype.toString.call(n)}function i(n){if(""!==n.id)return'id("'+n.id+'")';if(n===e.body)return n.tagName;var t=0;if(n.parentNode)for(var r=n.parentNode.childNodes,o=0;o<r.length;o++){var l=r[o];if(l===n)return i(n.parentNode)+"/"+n.tagName+"["+(t+1)+"]";1===l.nodeType&&l.tagName===n.tagName&&t++}}function l(n,t,e){var r,u,f;if(n){null==t&&(t={_text:""});var s=c(n);if(f=o(t)){if(p[e]&&0===s.length&&(p[e].parent.insertAdjacentHTML("beforeend",p[e].node),s=c(p[e].parent.children)),0===s.length)return;for(u=s[0].parentNode,p[e]||(p[e]={node:s[0].cloneNode(!0).outerHTML,parent:u});s.length<t.length;)p[e]?(u.insertAdjacentHTML("beforeend",p[e].node),r=u.lastChild):r=s[0].cloneNode(!0),s.push(r),u&&u.appendChild(r);for(;s.length>t.length;)r=s.pop(),(u=r.parentNode)&&(e=i(r),u.removeChild(r),g[e+"-config"]&&g[e+"-config"].configContext&&"function"==typeof g[e+"-config"].configContext.onunload&&g[e+"-config"].configContext.onunload())}for(r=0;r<s.length;r++)e=i(s[r]),f?!s[r]||g[e]&&g[e]===JSON.stringify(t[r])||(l(s[r],t[r]),g[e]=JSON.stringify(t[r])):a(s[r],t);return n}}function a(n,t){var e;if("function"!=typeof t){if("object"!=typeof t)return a(n,{_text:t});for(var c in t){var f=t[c];f===r&&(f=""),"_"===c[0]&&(e=e||{},e[c.substr(1)]=f)}var s=i(n);e&&u(n,e);var d=0;for(c in t)if(f=t[c],"_"!==c[0]){if(e=h(n,c),"function"==typeof f&&"fun"==f.type)try{f=f()}catch(g){}o(f)&&(e=h(n,"$"+c)),l(e,f,s+"/"+c),d++}}}function c(n){var t;if(null==n.length&&(n=[n]),!o(n)){t=[];for(var e=0;e<n.length;e+=1)n[e]&&t.push(n[e]);n=t}return n}function u(e,r){var o=i(e),l=!1;g[o]&&g[o]===JSON.stringify(r)&&(l=!0);for(var a in r)if("text"!==a&&"html"!==a)if(0==a.indexOf("on")){var c=function(t,e,r){try{return t.call(e,r)}finally{n.redraw()}}.bind(null,r[a],e);e[a]=c}else if("config"==a){c=!0,o=i(e),g[o+"-config"]?c=!c:g[o+"-config"]={};var u=g[o+"-config"].configContext=g[o+"-config"].configContext||{};t.push(function(n,t){return function(){return n.apply(n,t)}}(r[a],[e,c,u]))}else l||(null===r[a]?e.removeAttribute(a):e.setAttribute(a,""+r[a]));l||(f(e,r.text),s(e,r.html),g[o]=JSON.stringify(r))}function f(n,t){var e,r;if(e=i(n),n&&null!=t){if(!r){r=[];for(var o=0;o<n.childNodes.length;o+=1)e=n.childNodes[o],e.nodeType===d&&r.push(e)}for(;n.firstChild;)n.removeChild(n.firstChild);for("input"===n.nodeName.toLowerCase()?n.setAttribute("value",""+t):n.appendChild(n.ownerDocument.createTextNode(""+t)),o=0;o<r.length;o+=1)n.appendChild(r[o])}else if("[object Null]"===Object.prototype.toString.call(t)){for(;n.firstChild;)n.removeChild(n.firstChild);g[e+"-config"]&&g[e+"-config"].configContext&&"function"==typeof g[e+"-config"].configContext.onunload&&g[e+"-config"].configContext.onunload()}}function s(n,t){n&&null!=t&&(n.innerHTML=t)}function h(n,t,e){for(var r=n.childNodes,o=[],i=0;i<r.length;i+=1)r[i].nodeType===d&&o.push(r[i]);if(r=[],i=t,!(n.queryCache||{})[t]){n.queryCache=(n.queryCache||{})[t]=[];var l="$"===t[0];"$"===i[0]&&(i=i.substr(1));for(var a=0;a<o.length;a+=1){var c=o[a],u=i,f=" "+c.className+" ";(c.id===u||-1<f.indexOf(" "+u+" ")||c.name===u||c.nodeName.toLowerCase()===u.toLowerCase()||c.getAttribute("data-bind")===u)&&r.push(o[a])}if(!r.length||l)for(a=0;a<o.length&&(r=r.concat(h(o[a],t,!0)),!r.length||l);a++);!e&&!r.length,n.queryCache[t]=r}return n.queryCache[t]}var d=1,g=[],p={},g=[];n.fill={fill:l,configs:t},window.mag=n}(window.mag||{},[],document),function(n){function t(){_=null;for(var n=0;n<b.length;n++)b[n]();b.length=0}var e={noMore:!1,useDirtyCheck:!1},r=[],o=[],i=[],l=!1;try{l=Object.defineProperty&&Object.defineProperty({},"x",{})}catch(a){}var c=function(n){var t={};return n&&"[object Function]"==t.toString.call(n)},u=function(n){return"[object Array]"===Object.prototype.toString.call(n)},f=function(n){return"[object Object]"==={}.toString.apply(n)},s=function(n){if(null==n||"object"!=typeof n)return n;var t,e=n.constructor();for(t in n)e[t]=n[t];return e},h=function(n,t,e,r){try{Object.observe(n,function(n){n.forEach(function(n){n.name===t&&r(n.object[n.name])})})}catch(o){try{Object.defineProperty(n,t,{get:e,set:function(n){r.call(this,n,!0)},enumerable:!0,configurable:!0})}catch(i){try{Object.prototype.__defineGetter__.call(n,t,e),Object.prototype.__defineSetter__.call(n,t,function(n){r.call(this,n,!0)})}catch(l){g(n,t,r)}}}},d=function(n,t,e){try{Object.defineProperty(n,t,{enumerable:!1,configurable:!0,writable:!1,value:e})}catch(r){n[t]=e}},g=function(n,t,e){o[o.length]={prop:t,object:n,orig:s(n[t]),callback:e}},p=function(n,t,e,r){if("string"!=typeof n&&(n instanceof Object||u(n))){if(u(n)){if(N(n,"__watchall__",t,e),void 0===e||e>0)for(var o=0;o<n.length;o++)p(n[o],t,e,r)}else{var i=[];for(o in n)"$val"==o||!l&&"watchers"===o||Object.prototype.hasOwnProperty.call(n,o)&&i.push(o);v(n,i,t,e,r)}r&&q(n,"$$watchlengthsubjectroot",t,e)}},v=function(n,t,e,r,o){if("string"!=typeof n&&(n instanceof Object||u(n)))for(var i=0;i<t.length;i++)w(n,t[i],e,r,o)},w=function(n,t,e,r,o){"string"!=typeof n&&(n instanceof Object||u(n))&&(c(n[t])||(null==n[t]||void 0!==r&&0>=r||p(n[t],e,void 0!==r?r-1:r),N(n,t,e,r),o&&(void 0===r||r>0)&&q(n,t,e,r)))},m=function(n,t){if(!(n instanceof String)&&(n instanceof Object||u(n)))if(u(n)){for(var e=["__watchall__"],r=0;r<n.length;r++)e.push(r);y(n,e,t)}else{var o=function(n){var e,r=[];for(e in n)n.hasOwnProperty(e)&&(n[e]instanceof Object?o(n[e]):r.push(e));y(n,r,t)};o(n)}},y=function(n,t,e){for(var r in t)t.hasOwnProperty(r)&&$(n,t[r],e)},b=[],_=null,j=function(n){null==_&&(_||(_=setTimeout(t))),b[b.length]=n},O=function(n,e,r,o){var i=null,l=-1,a=u(n);p(n,function(r,o,c,u){var f=(_||(_=setTimeout(t)),_);if(l!==f&&(l=f,i={type:"update"},i.value=n,i.splices=null,j(function(){e.call(this,i),i=null})),a&&n===this&&null!==i){if("pop"===o||"shift"===o)c=[],u=[u];else if("push"===o||"unshift"===o)c=[c],u=[];else if("splice"!==o)return;i.splices||(i.splices=[]),i.splices[i.splices.length]={index:r,deleteCount:u?u.length:0,addedCount:c?c.length:0,added:c,deleted:u}}},1==r?void 0:0,o)},C=function(n,t,e,r,o){n&&t&&(w(n,t,function(n,t,i,l){n={type:"update"},n.value=i,n.oldvalue=l,(r&&f(i)||u(i))&&O(i,e,r,o),e.call(this,n)},0),(r&&f(n[t])||u(n[t]))&&O(n[t],e,r,o))},N=function(n,t,r,o){var i=!1,l=u(n);for(n.watchers||(d(n,"watchers",{}),l&&T(n,function(e,r,i,l){if(k(n,e,r,i,l),0!==o&&i&&(f(i)||u(i))){var a,c;for(e=n.watchers[t],(a=n.watchers.__watchall__)&&(e=e?e.concat(a):a),c=e?e.length:0,a=0;c>a;a++)if("splice"!==r)p(i,e[a],void 0===o?o:o-1);else for(l=0;l<i.length;l++)p(i[l],e[a],void 0===o?o:o-1)}})),n.watchers[t]||(n.watchers[t]=[],l||(i=!0)),l=0;l<n.watchers[t].length;l++)if(n.watchers[t][l]===r)return;if(n.watchers[t].push(r),i){var a=n[t];r=function(){return a},i=function(r,i){var l=a;if(a=r,0!==o&&n[t]&&(f(n[t])||u(n[t]))&&!n[t].watchers){var c,s=n.watchers[t].length;for(c=0;s>c;c++)p(n[t],n.watchers[t][c],void 0===o?o:o-1)}return n.watchers&&(n.watchers.__wjs_suspend__||n.watchers["__wjs_suspend__"+t])?void L(n,t):void(e.noMore||l!==r&&(i?k(n,t,"set",r,l):x(n,t,"set",r,l),e.noMore=!1))},e.useDirtyCheck?g(n,t,i):h(n,t,r,i)}},x=function(n,t,e,r,o){if(void 0!==t){var i,l=n.watchers[t];(i=n.watchers.__watchall__)&&(l=l?l.concat(i):i),i=l?l.length:0;for(var a=0;i>a;a++)l[a].call(n,t,e,r,o)}else for(t in n)n.hasOwnProperty(t)&&x(n,t,e,r,o)},S="pop push reverse shift sort slice unshift splice".split(" "),A=function(n,t,e,r){d(n,e,function(){var o,i,l,a;if(o=0,"splice"===e){var c=arguments[0];for(l=n.slice(c,c+arguments[1]),i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];o=c}else i=0<arguments.length?arguments[0]:void 0;return a=t.apply(n,arguments),"slice"!==e&&("pop"===e?(l=a,o=n.length):"push"===e?o=n.length-1:"shift"===e?l=a:"unshift"!==e&&void 0===i&&(i=a),r.call(n,o,e,i,l)),a})},T=function(n,t){if(c(t)&&n&&!(n instanceof String)&&u(n))for(var e,r=S.length;r--;)e=S[r],A(n,n[e],e,t)},$=function(n,t,e){if(n.watchers[t])if(void 0===e)delete n.watchers[t];else for(var i=0;i<n.watchers[t].length;i++)n.watchers[t][i]==e&&n.watchers[t].splice(i,1);for(i=0;i<r.length;i++){var l=r[i];l.obj==n&&l.prop==t&&l.watcher==e&&r.splice(i,1)}for(e=0;e<o.length;e++)i=o[e],l=i.object.watchers,(i=i.object==n&&i.prop==t&&l&&(!l[t]||0==l[t].length))&&o.splice(e,1)},L=function(n,t){j(function(){delete n.watchers.__wjs_suspend__,delete n.watchers["__wjs_suspend__"+t]})},P=null,k=function(n,t,e,r,o){i[i.length]={obj:n,prop:t,mode:e,newval:r,oldval:o},null===P&&(P=setTimeout(J))},J=function(){var n=null;P=null;for(var t=0;t<i.length;t++)n=i[t],x(n.obj,n.prop,n.mode,n.newval,n.oldval);n&&(i=[])},q=function(n,t,e,o){var i;i=s("$$watchlengthsubjectroot"===t?n:n[t]),r.push({obj:n,prop:t,actual:i,watcher:e,level:o})};e.watch=function(){c(arguments[1])?p.apply(this,arguments):u(arguments[1])?v.apply(this,arguments):w.apply(this,arguments)},e.unwatch=function(){c(arguments[1])?m.apply(this,arguments):u(arguments[1])?y.apply(this,arguments):$.apply(this,arguments)},e.callWatchers=x,e.suspend=function(n,t){n.watchers&&(n.watchers["__wjs_suspend__"+(void 0!==t?t:"")]=!0)},e.onChange=function(){(c(arguments[2])?C:O).apply(this,arguments)},n.watch=e}(window.mag||{}),function(n){var t={modules:[],controllers:[],elements:[],submodule:function(n,t){var e=function(t){return(n.controller||function(){}).apply(this,t)}.bind({},t);return e.$original=n.controller,e={controller:e,view:function(e){1<arguments.length&&(t=t.concat([].slice.call(arguments,1)));var r=n.view.apply(n,t?[e].concat(t):[e]);return t[0]&&null!=t[0].key&&(r.attrs.key=t[0].key),r}},t[0]&&null!=t[0].key&&(e.attrs={key:t[0].key}),e},getArgs:function(n){return t.modules[n].controller&&t.modules[n].controller.$$args?[t.controllers[n]].concat(t.modules[n].controller.$$args):[t.controllers[n]]}};n.mod=t}(window.mag||{}),function(n){var t={roots:[],templates:{},cache:{},callOnload:function(n){for(var t,e=0;t=n.controllers[e];e++)t.onload&&!t.called&&(t.onload.call(null,n.elements[e]),t.called=1)},callConfigs:function(n){for(var t=0,e=n.length;e>t;t++)n[t]()}},e=[];t.redraw=function(n,e,r){n=n||t.module||{},this.fun||(this.fun=i(function(){e.configs.splice(0,e.configs.length),t.doLoop(n,e,r)})),this.fun()},t.doLoop=function(e,r,o){for(var i=0;t.roots[i];i++)n.running=!0,!e.controllers[i]||t.innerLoop(e,r,i,o)},t.innerLoop=function(n,r,o,i){var l=n.elements[o],a=n.getArgs(o);return e[o]&&e[o]===JSON.stringify(a[0])?n=!1:((n.getArgs(o),n.modules[o]).view(l,n.controllers[o]),e[o]=JSON.stringify(a[0]),t.setupWatch(i,a,r,l,o,n),r.fill(l,a[0]),t.callConfigs(r.configs),n=void t.callOnload(n)),n},t.doWatch=function(r,o,i,l){n.running=!0;var a=l.getArgs(i);e[i]&&e[i]===JSON.stringify(a[0])||((l.getArgs(i),l.modules[i]).view(o,l.controllers[i]),e[i]=JSON.stringify(a[0]),r.fill(o,a[0]),t.callConfigs(r.configs),n.running=!1)},t.setupWatch=function(n,e,r,o,l,a){n.watch(e[0],i(t.doWatch.bind(null,r,o,l,a)))};var r=window.cancelAnimationFrame||window.clearTimeout,o=window.requestAnimationFrame||window.setTimeout,i=function(n,t){var e,i,l=t||16;return function(){+new Date-e>l||o===window.requestAnimationFrame?(i>0&&r(i),i=o(function(){e=+new Date,n.apply(this,arguments)},l)):(e=+new Date,n.apply(this,arguments),i=o(function(){i=null},l))}};n.render=t}(window.mag||{}),function(n,t){var e={},r=n.mod,o=n.render,i=n.fill,l=n.watch;n.running=!1,e.init=function(){};var a=!1;e.redraw=function(){a||(a=!0,o.redraw(r||o.module||{},i,l),a=!1)},e.withProp=function(n,t){return function(e){e=e||event,e=e.currentTarget||this,t(n in e?e[n]:e.getAttribute(n))}},e.prop=function(n){var t=function(){return arguments.length&&(n=arguments[0],e.redraw()),n};return t.type="fun",t.toJSON=function(){return n},t};var c=[];e.module=function(i,l,a){var u=o.roots.indexOf(i);0>u&&(u=o.roots.length);for(var f,s=!1,h={preventDefault:function(){s=!0}},d=0;f=c[d];d++)f.handler(h),f.controller.onunload=null;if(s)for(d=0;f=c[d];d++)f.controller.onunload=f.handler;else c=[];return s?void 0:(i=t.getElementById(i))?(o.roots[u]=i.id,l.view?(l=r.submodule(l,[a||{}]),a=new l.controller,r.controllers[u]=a,a.onunload&&c.push({controller:a,handler:a.onunload}),r.modules[u]=l,r.elements[u]=i,e.redraw(),a.onload&&!n.running&&o.callOnload(r),{_html:i.innerHTML}):Error("module requires a view")):Error("invalid node")};var u=function(n){return function(){return e[n].apply(this,arguments)}},f=u("init");f.module=u("module"),f.prop=u("prop"),f.redraw=u("redraw"),f.withProp=u("withProp");for(var s in f)n[s]=f[s]}(window.mag||{},document);
