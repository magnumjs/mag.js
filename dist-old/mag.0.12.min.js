/*
Mag.JS v0.12
http://github.com/magnumjs/mag.js
(c) Michael Glazer
License: MIT
*/
!function(e,n,t,r){"use strict";function o(e){return"[object Array]"===Object.prototype.toString.call(e)}function i(e){if(""!==e.id)return'id("'+e.id+'")';if(e===t.body)return e.tagName;var n=0;if(e.parentNode)for(var r=e.parentNode.childNodes,o=0;o<r.length;o++){var a=r[o];if(a===e)return i(e.parentNode)+"/"+e.tagName+"["+(n+1)+"]";1===a.nodeType&&a.tagName===e.tagName&&n++}}function a(e){var n=i(e);e.parentNode.removeChild(e),x[n+"-config"]&&x[n+"-config"].configContext&&typeof x[n+"-config"].configContext.onunload===_&&x[n+"-config"].configContext.onunload(x[n+"-config"].configContext,e,n)}function l(e){var n=e&&parseInt(e.split("[").pop().slice(0,-1));return n?parseInt(n)-1:0}function c(e,n,t){var l,u,s;if(e){null==n&&(n={_text:""});var h=d(e);if(s=o(n)){if(L[t]=L[t]||0,T[t]&&0===h.length&&(T[t].parent.insertAdjacentHTML("beforeend",T[t].node),h=d(T[t].parent.children)),0===h.length)return L[t]=0,r;for(u=h[0].parentNode,T[t]||(T[t]={node:h[0].cloneNode(!0).outerHTML,parent:u});h.length<n.length;)T[t]?(u.insertAdjacentHTML("beforeend",T[t].node),l=u.lastChild):l=h[0].cloneNode(!0),h.push(l),u&&u.appendChild(l);var p=(h.map(function(e){return e.__key}),n.map(function(e){return e[k]}));if(h.length==n.length||-1!==p.indexOf(r))var n=n.map(function(e,n){if("object"==typeof e){if(h[n].__key&&typeof e[k]===O)return e[k]=h[n].__key,e;typeof e[k]===O&&(e[k]=N+n),h[n].__key=e[k]}return e});if(h.length>n.length)if(0===n.length||"object"!=typeof n[0])for(;h.length>n.length;)l=h.pop(),u=l.parentNode,u&&a(l);else var v=[],g=n.map(function(e){return e[k]}),h=(h.map(function(e){return e.__key}),h.filter(function(e){return-1===g.indexOf(e.__key)||-1!==v.indexOf(e.__key)?(v.push(e.__key),a(e),!1):(v.push(e.__key),!0)}))}for(var m=0;m<h.length;m++){{i(h[m])}s?h[m]&&c(h[m],n[m]):(n&&"object"==typeof n&&-1!==Object.keys(n).indexOf(k)&&(h[m][N]=h[m][N]||{},h[m][N].isChildOfArray=!0,h[m][N].dataPass=n),f(h[m],n))}return e}}function u(e){return e.parentNode&&e.parentNode[N]&&e.parentNode[N].isChildOfArray?e.parentNode:e.parentNode?u(e.parentNode):r}function f(e,n){var t,l;if(typeof n!==_){if("object"!=typeof n)return f(e,{_text:n});for(var u in n){var d=n[u];if(d===r)d="";else if(null===d&&-1===["onunload"].indexOf(u)){var h=m(e,u);h.forEach(function(e){a(e)})}"_"===u[0]&&(t=t||{},t[u.substr(1)]=d)}var p=i(e);t&&s(e,t);var v=0,g=["willupdate","didupdate","didload","willload","isupdate"];for(var u in n)if(-1===g.indexOf(u)){var d=n[u];"_"!==u[0]&&(l=m(e,u),typeof d===_&&"fun"==d.type&&(d=d()),o(d)&&(l=m(e,"$"+u)),c(l,d,p+"/"+u),v++)}}}function d(e){var n;if(null==e.length&&(e=[e]),!o(e)){n=[];for(var t=0;t<e.length;t+=1)e[t]&&n.push(e[t]);e=n}return e}function s(t,r){var o=i(t),a=l(o);for(var c in r)if("text"!==c&&"html"!==c)if(0==c.indexOf("on")){var f=function(n,t,r){var o=u(t),a=o&&i(o),c=l(a),f=i(t),d=l(f),s={path:a,data:((o||{})[N]||[]).dataPass,node:o,index:c},h=n.call(t,r,d,t,s);return e.redraw(),h}.bind({},r[c],t);t[c]=f}else{if("config"==c){var d=!0;x[o+"-config"]?d=!1:x[o+"-config"]={};var s=x[o+"-config"].configContext=x[o+"-config"].configContext||{},p=function(e,n){return function(){return e.apply(e,n)}};n.push(p(r[c],[t,d,s,a]));continue}var v={key:c,value:r[c],node:t};e.hook("attributes",c,v),v.change&&(c=v.key,r[c]=v.value),null===r[c]?t.removeAttribute(c):t.setAttribute(c,""+r[c])}h(t,r.text),g(t,r.html,a)}function h(e,n){var t,r;if(e&&null!=n){if(!r){r=[];for(var o=0;o<e.childNodes.length;o+=1)t=e.childNodes[o],t.nodeType===C&&r.push(t)}for(;e.firstChild;)e.removeChild(e.firstChild);"input"===e.nodeName.toLowerCase()?e.setAttribute("value",""+n):e.appendChild(e.ownerDocument.createTextNode(""+n));for(var o=0;o<r.length;o+=1)e.appendChild(r[o])}}function p(e,n){return-1!==e.indexOf(n,e.length-n.length)}function v(e,n){e.cloner&&(e.id=N+e.id.split(N).pop()+(p(e.id,n)?"":n))}function g(e,n,r){if(e&&null!=n){for(;e.firstChild;)e.removeChild(e.firstChild);if(typeof n===_&&1===n().nodeType){v(n(),r);var o=t.createElement("span");e.appendChild(o),e.replaceChild(n(),o)}else if(1===n.nodeType){v(n,r);var o=t.createElement("span");e.appendChild(o),e.replaceChild(n,o)}else e.innerHTML=n}}function m(n,t,r){var o=y(n),i=[],a=t,l="$"===t[0];"$"===a[0]&&(a=a.substr(1));for(var c=0;c<o.length;c+=1)w(o[c],a)&&i.push(o[c]);if(!i.length||l)for(var c=0;c<o.length&&(i=i.concat(m(o[c],t,!0)),!i.length||l);c++);if(!r&&!i.length){var u={key:t,value:i,node:n};e.hook("elementMatcher",t,u),u.change&&(i=u.value)}return i}function y(e){for(var n=e.childNodes,t=[],r=0;r<n.length;r+=1)n[r].nodeType===C&&t.push(n[r]);return t}function w(e,n){var t=" "+e.className+" ";return e.id===n||t.indexOf(" "+n+" ")>-1||e.name===n||e.nodeName.toLowerCase()===n.toLowerCase()||e.getAttribute("data-bind")===n}function b(e,n){var n={tag:e.tagName};if(n.children=[],e.firstChild||e.children[0]){var t=e.firstChild||e.childNodes[0],r=t.nodeValue||t.value||t.innerText;r&&(r=r.replace(/\u00a0/g,"x").trim()),r&&n.children.push(r)}var o=0;for(n.attrs={},o;o<e.attributes.length;o++)n.attrs[e.attributes[o].name]=e.attributes[o].value;var i=e.children;if(i.length)for(o=0;o<i.length;o++){var a=i[o];n.children.push(b(a,n.children))}return n}var C=1,x=[],N="__magnum__",_="function",O="undefined",k="_key",T={},L={};e.fill={fill:c,elementToObject:b,cached:x,find:m,configs:n},window.mag=e}(window.mag||{},[],document),function(e){"use strict";function n(e,n,t){{var r=n.getArgs(t),o=n.modules[t];n.controllers[t]}o&&o.view(r[0],e)}function t(e,n,t){for(var r in n.cached)-1!==r.indexOf('id("'+e.elements[t].id+'")/')&&-1!==r.indexOf("-config")&&n.cached[r].configContext&&a.unloaders.push({controller:n.cached[r].configContext,handler:n.cached[r].configContext.onunload})}function r(e,n,t){var r;return function(){function o(){t||e.apply(i,a),r=null}var i=this,a=arguments;r?u(r):t&&e.apply(i,a),r=f(o,n)}}function o(e){var n=Object.getNotifier(e);for(var t in e){var r=e[t];if(!r||"object"!=typeof r)break;Object.observe(r,function(e){e.forEach(function(e){n.notify(e)})}),o(r)}}function i(e,n){e&&void 0!==Object.observe&&(s=r(n,16),o(e),Object.observe(e,s))}var a={roots:[],contexts:[],templates:{},unloaders:[],cache:{}},l=function(e,n){return a.cache[e]&&a.cache[e]===JSON.stringify(n)?!0:void(a.cache[e]=JSON.stringify(n))};a.callLCEvent=function(e,n,t,r){var o=!1,i={preventDefault:function(){o=!0}};if(n.controllers[t]&&n.controllers[t][e]&&(n.controllers[t][e].call({},i,n.elements[t]),r&&(n.controllers[t][e]=0)),o)for(var l,c=0;l=a.unloaders[c];c++)l.controller.onunload&&(l.handler.call(l.controller,n.elements[t]),l.controller.onunload=0);return o},a.callConfigs=function(e){for(var n=0,t=e.length;t>n;n++)e[n]()},a.redraw=function(e,n,t){e=e||a.module||{},t&&(a.cache={}),this.fun=this.fun||d(function(){n.configs.splice(0,n.configs.length),a.doLoop(e,n)}),this.fun()},a.doLoop=function(n,r){for(var o,i=0;o=a.roots[i];i++)if(n.controllers[i]&&n.elements[i]){if(a.callLCEvent("willload",n,i,1))return;a.innerLoop(n,r,i)&&(n.deferreds[i][1]({_html:e.prop(n.elements[i])}),a.callLCEvent("didload",n,i,1),a.callConfigs(r.configs),t(n,r,i),n.deferreds[i][0]&&(delete n.elements[i],delete n.modules[i],delete n.controllers[i],delete n.promises[i],delete n.deferreds[i]))}},a.clear=function(e){-1!==e&&a.cache[e]&&delete a.cache[e]},a.innerLoop=function(e,t,r){var o=e.elements[r],i=e.getArgs(r);return l(r,i)?!1:(n(o,e,r),a.setupWatch(i,t,o,r,e),t.fill(o,i[0]),!0)};var c;a.doWatch=function(e,t,r,o,i,u){if(u!=c){c=u,a.callLCEvent("willupdate",o,r,1);var f=o.getArgs(r);if(l(r,f))return void a.callLCEvent("didupdate",o,r);a.callLCEvent("isupdate",o,r),n(t,o,r),e.fill(t,f[0])}},a.setupWatch=function(e,n,t,r,o){var l=function(i){i.forEach(function(e){"update"==e.type&&e.oldValue&&"fun"==e.oldValue.type&&e.oldValue.data&&"module"==e.oldValue.data.type&&!e.object[e.name].data&&a.callLCEvent("onunload",o,e.oldValue.data.id,1)}),o.controllers[r]=e[0],d(a.doWatch.bind({},n,t,r,o,i))()};s&&e[0]&&void 0!==Object.unobserve&&Object.unobserve(e[0],s),i(e[0],l)};var u=window.cancelAnimationFrame||window.clearTimeout,f=window.requestAnimationFrame||window.setTimeout,d=function(n,t){var r,o,i=t||16;return function(){var t=arguments;if(f===window.requestAnimationFrame||+new Date-r>i)o>0&&u(o),o=f(function(){r=+new Date;var o=[].slice.call(arguments).concat([].slice.call(t));n.apply(this,o),e.redrawing=!1},i);else{r=+new Date;var a=[].slice.call(arguments).concat([].slice.call(t));n.apply(this,a),o=f(function(){o=null,e.redrawing=!1},i)}}};e.render=a;var s}(window.mag||{}),function(e){"use strict";function n(e,n,t){r[e]||(r[e]=[]);for(var i in n[0])r[e][i]||(o(e,i,n[0],t),r[e][i]=!0)}var t={modules:[],promises:[],deferreds:[],controllers:[],elements:[]};t.getController=function(e,n,t){var r;return r="undefined"!=typeof Proxy?new Proxy(new e.controller,{get:function(e,r){if(void 0===e[r]&&-1===["watchers","toJSON","called","onload","onunload"].indexOf(r)){var o,i=t.find(n,r),a="$"===r[0],l=[];return i.forEach(function(e,n){i[n]&&(i[n].value&&i[n].value.length>0?(o=i[n].value,!i[n].type||"checkbox"!=i[n].type&&"radio"!=i[n].type||(o={_text:o,_checked:i[n].checked},l.push(o))):i[n].innerText&&i[n].innerText.length>0?o=i[n].innerText:i[0].innerHTML&&i[n].innerHTML.length>0&&(o=i[n].innerHTML))}),l.length>0&&a?l:o}return e[r]}}):new e.controller},t.submodule=function(e,n){var t=function(){return(e.controller||function(){}).apply(this,n)||this},r=function(t){if(arguments.length>1)var r=n.concat([].slice.call(arguments,1));e.view.apply(e,r?[t].concat(r):[t])},o={controller:t,view:r};return t.$$args=n,o},t.getArgs=function(e){var r=t.modules[e]&&t.modules[e].controller&&t.modules[e].controller.$$args?[t.controllers[e]].concat(t.modules[e].controller.$$args):[t.controllers[e]];return n(e,r,this.elements[e]),r};var r=[],o=function(n,t,r,o){var i=r[t],a=e.fill.find(o,t);"function"!=typeof i&&a[0]&&-1!==["INPUT","SELECT","TEXTAREA"].indexOf(a[0].tagName)&&Object.defineProperty(r,t,{get:function(){var n=e.fill.find(o,t);return n[0]&&n[0].value&&n[0].value!==i?n[0].value:i}})};e.mod=t}(window.mag||{}),function(e,n){"use strict";function t(n,t){var r=function(){return arguments.length&&(n=arguments[0],e.redraw()),n};return r.type="fun",r.data=t?t:null,r.toJSON=function(){return n&&n.nodeType?l.elementToObject(n):n},r}function r(n,t,o){var i=e.prop(t,o);return n.then(i),i.then=function(e,o){return r(n.then(e,o),t)},i}function o(e,n,t,r,o){r.change=!1,d[n][t].key==e&&(o=JSON.stringify({v:r.value,k:r.key}),d[n][t].handler.call(d[n][t].context,r),o!==JSON.stringify({v:r.value,k:r.key})&&(r.change=!0))}var i=e.mod,a=e.render,l=e.fill,c={}.toString,u="function",f="[object Object]",d={attributes:[],elementMatcher:[]};e.redrawing=!1,e.redraw=function(n){e.redrawing||(e.redrawing=!0,a.redraw(i||a.module||{},l,n))},e.withProp=function(e,n){return function(t){t=t||event;var r=t.currentTarget||this;n(e in r?r[e]:r.getAttribute(e))}},e.prop=function(e,n){return(null!=e&&c.call(e)===f||typeof e===u)&&typeof e.then===u?r(e,n):t(e,n)},e.hookin=function(e,n,t){d[e].push({context:{},handler:t,key:n})},e.hook=function(e,n,t){for(var r=0,i=d[e].length;i>r;r++)o(n,e,r,t)};var s=function(e){a.callLCEvent("onreload",i,e)};e.module=function(t,o,c,u){var f=a.roots.indexOf(t);if(-1>=f||!s(f,t)){c&&!c.retain&&a.clear(f,t,l),(0>f||u)&&(f=a.roots.length);var d=n.getElementById(t);if(!d)throw Error("Mag.JS Module - invalid node id: "+t);if(a.roots[f]=t,!o.view)throw Error("Mag.JS module - requires a view: "+t+o);var h=i.submodule(o,[c||{}]),p=i.getController(h,d,l);return i.controllers[f]=p,p.onunload&&a.unloaders.push({controller:p,handler:p.onunload}),i.modules[f]=h,i.elements[f]=u?d.cloneNode(!0):d,i.elements[f].cloner=u,i.promises[f]=new Promise(function(){i.deferreds[f]=arguments}.bind({},u)),e.redraw(),r(i.promises[f],{_html:e.prop(i.elements[f])},{type:"module",id:f})}}}(window.mag||{},document);
