/*
Mag.JS v0.10.1
http://github.com/magnumjs/mag.js
(c) Michael Glazer
License: MIT
*/
!function(e,n,t,r){function o(e){return"[object Array]"===Object.prototype.toString.call(e)}function i(e){if(""!==e.id)return'id("'+e.id+'")';if(e===t.body)return e.tagName;var n=0;if(e.parentNode)for(var r=e.parentNode.childNodes,o=0;o<r.length;o++){var l=r[o];if(l===e)return i(e.parentNode)+"/"+e.tagName+"["+(n+1)+"]";1===l.nodeType&&l.tagName===e.tagName&&n++}}function l(e){var n=i(e);e.queryCache,e.parentNode.removeChild(e),y[n+"-config"]&&y[n+"-config"].configContext&&"function"==typeof y[n+"-config"].configContext.onunload&&y[n+"-config"].configContext.onunload(y[n+"-config"].configContext,e,n),delete y[n];for(var t in y)0===t.indexOf(n)&&delete y[t]}function a(e){return(e=e&&parseInt(e.split("[").pop().slice(0,-1)))?parseInt(e)-1:0}function c(e,n,t){var a,u,s;if(e){null==n&&(n={_text:""});var h=d(e);if(s=o(n)){if(b[t]=b[t]||0,C[t]&&0===h.length&&(C[t].parent.insertAdjacentHTML("beforeend",C[t].node),h=d(C[t].parent.children),"object"==typeof n[0]),0===h.length)return;for(u=h[0].parentNode,C[t]||(C[t]={node:h[0].cloneNode(!0).outerHTML,parent:u});h.length<n.length;)C[t]?(u.insertAdjacentHTML("beforeend",C[t].node),a=u.lastChild):a=h[0].cloneNode(!0),h.push(a),u&&u.appendChild(a);if(void 0===h[0].__key&&"object"==typeof n[0],a=n.map(function(e){return e[w]}),(h.length==n.length||-1!==a.indexOf(r))&&(n=n.map(function(e,n){return"object"==typeof e&&(void 0===e[w]&&(e[w]="__magnum__"+b[t]++),h[n].__key=e[w]),e})),h.length>n.length)if(0===n.length||"object"!=typeof n[0])for(;h.length>n.length;)a=h.pop(),(u=a.parentNode)&&l(a);else var g=n.map(function(e){return e[w]}),h=(h.map(function(e){return e.__key}),h.filter(function(e){return-1===g.indexOf(e.__key)?(l(e),!1):!0}))}for(a=0;a<h.length;a++)u=i(h[a]),s?h[a]&&(y[u]&&y[u]===JSON.stringify(n[a]),c(h[a],n[a]),h[a].queryCache):(n&&"object"==typeof n&&-1!==Object.keys(n).indexOf(w)&&(h[a].isChildOfArray=!0,h[a]._dataPass=n),f(h[a],n));return e}}function u(e){return e.parentNode&&e.parentNode.isChildOfArray?e.parentNode:e.parentNode?u(e.parentNode):void 0}function f(e,n){var t;if("function"!=typeof n){if("object"!=typeof n)return f(e,{_text:n});for(var a in n){var u=n[a];u===r?u="":null===u&&-1===["onunload"].indexOf(a)&&v(e,a).forEach(function(e){l(e)}),"_"===a[0]&&(t=t||{},t[a.substr(1)]=u)}var d=i(e);t&&s(e,t);var h=0,g=["willupdate","didupdate","didload","willload"];for(a in n)if(-1===g.indexOf(a)&&(u=n[a],"_"!==a[0])){if(t=v(e,a),"function"==typeof u&&"fun"==u.type)try{u=u()}catch(p){}o(u)&&(t=v(e,"$"+a)),c(t,u,d+"/"+a),h++}}}function d(e){var n;if(null==e.length&&(e=[e]),!o(e)){n=[];for(var t=0;t<e.length;t+=1)e[t]&&n.push(e[t]);e=n}return e}function s(t,r){var o=i(t),l=a(o);y[o]&&y[o]===JSON.stringify(r),t._events=t._events||[];for(var c in r)if("text"!==c&&"html"!==c)if(0==c.indexOf("on")){if(-1===t._events.indexOf(c)||x){var f=function(n,t,r,o,i){try{return n.call(t,i,r,t,o)}finally{e.redraw()}}.bind(null,r[c],t,l,(u(t)||{})._dataPass);t[c]=f,t._events.push(c)}}else if("config"==c){f=!0,y[o+"-config"]?f=!1:y[o+"-config"]={};var d=y[o+"-config"].configContext=y[o+"-config"].configContext||{};n.push(function(e,n){return function(){return e.apply(e,n)}}(r[c],[t,f,d,l]))}else f={key:c,value:r[c],node:t},e.hook("attributes",c,f),f.change&&(c=f.key,r[c]=f.value),null===r[c]?t.removeAttribute(c):t.setAttribute(c,""+r[c]);h(t,r.text),p(t,r.html),t.queryCache}function h(e,n){var t,r;if(i(e),e&&null!=n){if(!r){r=[];for(var o=0;o<e.childNodes.length;o+=1)t=e.childNodes[o],t.nodeType===m&&r.push(t)}for(;e.firstChild;)e.removeChild(e.firstChild);for("input"===e.nodeName.toLowerCase()?e.setAttribute("value",""+n):e.appendChild(e.ownerDocument.createTextNode(""+n)),o=0;o<r.length;o+=1)e.appendChild(r[o])}}function g(e){e.cloner&&(e.id="__magnum__::"+e.id.split("__magnum__::").pop())}function p(e,n){if(e&&null!=n){for(;e.firstChild;)e.removeChild(e.firstChild);if("function"==typeof n&&1===n().nodeType){g(n());var r=t.createElement("span");e.appendChild(r);try{e.replaceChild(n(),r)}catch(o){console.log("FILL HTML ERROR",n().id,o)}}else 1===n.nodeType?(g(n),r=t.createElement("span"),e.appendChild(r),e.replaceChild(n,r)):e.innerHTML=n}}function v(n,t,r){for(var o=n.childNodes,i=[],l=0;l<o.length;l+=1)o[l].nodeType===m&&i.push(o[l]);var o=[],l=t,a="$"===t[0];"$"===l[0]&&(l=l.substr(1));for(var c=0;c<i.length;c+=1){var u=i[c],f=l,d=" "+u.className+" ";(u.id===f||-1<d.indexOf(" "+f+" ")||u.name===f||u.nodeName.toLowerCase()===f.toLowerCase()||u.getAttribute("data-bind")===f)&&o.push(i[c])}if(!o.length||a)for(c=0;c<i.length&&(o=o.concat(v(i[c],t,!0)),!o.length||a);c++);return r||o.length||(n={key:t,value:o,node:n},e.hook("elementMatcher",t,n),n.change),o}var m=1,y=[],w="_key",C={},y=[],b={},x=!1;e.fill={fill:c,cached:y,find:v,clear:function(){x=!0},unclear:function(){x=!1},configs:n},window.mag=e}(window.mag||{},[],document),function(e){var n={modules:[],promises:[],deferreds:[],controllers:[],elements:[],getController:function(e,n,t){return"undefined"!=typeof Proxy?new Proxy(new e.controller,{get:function(e,r){if(void 0===e[r]&&-1===["watchers","toJSON","called","onload","onunload"].indexOf(r)){var o,i=t.find(n,r),l="$"===r[0],a=[];return i.forEach(function(e,n){i[n]&&(i[n].value&&0<i[n].value.length?(o=i[n].value,!i[n].type||"checkbox"!=i[n].type&&"radio"!=i[n].type||(o={_text:o,_checked:i[n].checked},a.push(o))):i[n].innerText&&0<i[n].innerText.length?o=i[n].innerText:i[0].innerHTML&&0<i[n].innerHTML.length&&(o=i[n].innerHTML))}),0<a.length&&l?a:o}return e[r]}}):new e.controller},submodule:function(e,n){var t=function(n){return(e.controller||function(){}).apply(this,n)}.bind({},n);return t.$original=e.controller,t.$$args=n,t={controller:t,view:function(t){if(1<arguments.length)var r=n.concat([].slice.call(arguments,1));r=e.view.apply(e,r?[t].concat(r):[t]),n[0]&&null!=n[0].key&&(r.attrs.key=n[0].key)}},n[0]&&null!=n[0].key&&(t.attrs={key:n[0].key}),t},getArgs:function(e){return n.modules[e].controller&&n.modules[e].controller.$$args?[n.controllers[e]].concat(n.modules[e].controller.$$args):[n.controllers[e]]}};e.mod=n}(window.mag||{}),function(e){function n(e,n,t){var r=n.getArgs(t),i=n.modules[t];n.controllers[t],n=o.contexts[t]=o.contexts[t]||{};try{i.view(r[0],e,n)}catch(l){console.log("Mag.JS",e.id,t,l)}}function t(e,n,t){for(var r in n.cached)-1!==r.indexOf('id("'+e.elements[t].id+'")/')&&n.cached[r].configContext&&o.unloaders.push({controller:n.cached[r].configContext,handler:n.cached[r].configContext.onunload})}function r(e,n){e&&void 0!==Object.observe&&Object.observe(e,function(t){t.forEach(function(t){"object"==typeof e[t.name]&&r(e[t.name],n)}),n.apply(this,arguments)})}var o={roots:[],contexts:[],templates:{},cache:{},unloaders:[],callLCEvent:function(e,n,t,r){var i=!1,l={preventDefault:function(){i=!0}};if(n.controllers[t][e]&&(n.controllers[t][e].call({},l,n.elements[t]),r&&(n.controllers[t][e]=0)),i)for(r=0;e=o.unloaders[r];r++)e.controller.onunload&&(e.handler.call(e.controller,n.elements[t]),e.controller.onunload=0);return i},callConfigs:function(e){for(var n=0,t=e.length;t>n;n++)e[n]()}},i=[];o.redraw=function(e,n,t){e=e||o.module||{},t&&(i=[]),this.fun=this.fun||u(function(){n.configs.splice(0,n.configs.length),o.doLoop(e,n)}),this.fun()},o.doLoop=function(n,r){for(var i=0;o.roots[i];i++)if(e.running=!0,n.controllers[i]&&n.elements[i]){if(o.callLCEvent("willload",n,i,1))return;if(o.innerLoop(n,r,i)&&(n.deferreds[i][2]({_html:function(e){return e}.bind({},n.elements[i])}),o.callLCEvent("didload",n,i,1),o.callConfigs(r.configs),t(n,r,i),n.deferreds[i][0])){var l=n.deferreds[i][1];delete n.elements[l],n.modules[l],n.controllers[l],n.promises[l],n.deferreds[l]}}r.unclear()},o.clear=function(e,n,t){-1!==e&&i[e]&&t.clear()},o.innerLoop=function(e,t,r){var l=e.elements[r],a=e.getArgs(r);return i[r]&&i[r]===JSON.stringify(a)?!1:(n(l,e,r),i[r]=JSON.stringify(a),o.setupWatch(a,t,l,r,e),t.fill(l,a[0]),!0)};var l;o.doWatch=function(t,r,a,c,u,f){if(f!=l){if(l=f,e.running=!0,o.callLCEvent("willupdate",c,a,1),u=c.getArgs(a),i[a]&&i[a]===JSON.stringify(u))return void o.callLCEvent("didupdate",c,a);n(r,c,a),i[a]=JSON.stringify(u),t.fill(r,u[0]),e.running=!1}},o.setupWatch=function(e,n,t,i,l){r(e[0],function(r){l.controllers[i]=e[0],u(o.doWatch.bind({},n,t,i,l,r))()})};var a=window.cancelAnimationFrame||window.clearTimeout,c=window.requestAnimationFrame||window.setTimeout,u=function(e,n){var t,r,o=n||16;return function(){if(+new Date-t>o||c===window.requestAnimationFrame){r>0&&a(r);var n=arguments;r=c(function(){t=+new Date;var r=[].slice.call(arguments).concat([].slice.call(n));e.apply(this,r)},o)}else{t=+new Date;var i=[].slice.call(arguments).concat([].slice.call(n));e.apply(this,i),r=c(function(){r=null},o)}}};e.render=o}(window.mag||{}),function(e,n){function t(n){var t=function(){return arguments.length&&(n=arguments[0],e.redraw()),n};return t.type="fun",t.toJSON=function(){return n&&n.nodeType&&n.innerHTML?n.innerHTML:n},t}function r(n,t){var o=e.prop(t);return n.then(o),o.then=function(e,o){return r(n.then(e,o),t)},o}var o=e.mod,i=e.render,l=e.fill,a={}.toString,c=e.running=!1;e.redraw=function(e){c||(c=!0,i.redraw(o||i.module||{},l,e),c=!1)},e.withProp=function(e,n){return function(t){t=t||event,t=t.currentTarget||this,n(e in t?t[e]:t.getAttribute(e))}},e.prop=function(e){return(null!=e&&"[object Object]"===a.call(e)||"function"==typeof e)&&"function"==typeof e.then?r(e):t(e)};var u={attributes:[],elementMatcher:[]};e.hookin=function(e,n,t){u[e].push({context:{},handler:t,key:n})},e.hook=function(e,n,t,r){for(var o in u[e])t.changed=!1,u[e][o].key==n&&(r=JSON.stringify({v:t.value,k:t.key}),u[e][o].handler.call(u[e][o].context,t),r!==JSON.stringify({v:t.value,k:t.key})&&(t.change=!0))},e.module=function(t,a,c,u){var f=i.roots.indexOf(t);c&&!c.retain&&i.clear(f,t,l),(0>f||u)&&(f=i.roots.length);var d=n.getElementById(t);if(!d)throw Error("Mag.JS Module - invalid node id: "+t);if(i.roots[f]=d.id,!a.view)throw Error("Mag.JS module - requires a view: "+JSON.stringify(a));return t=o.submodule(a,[Object.freeze(c||{})]),a=o.getController(t,d,l),o.controllers[f]=a,a.onunload&&i.unloaders.push({controller:a,handler:a.onunload}),o.modules[f]=t,o.elements[f]=u?d.cloneNode(!0):d,o.elements[f].cloner=u,o.promises[f]=new Promise(function(){o.deferreds[f]=arguments}.bind({},u,f)),e.redraw(),r(o.promises[f],{_html:function(){return o.elements[f]}})}}(window.mag||{},document);
