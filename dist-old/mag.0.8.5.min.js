/*
Mag.JS v0.8.5
http://github.com/magnumjs/mag.js
(c) Michael Glazer
License: MIT
*/
!function(e,n,t,r){function o(e){return"[object Array]"===Object.prototype.toString.call(e)}function i(e){if(""!==e.id)return'id("'+e.id+'")';if(e===t.body)return e.tagName;var n=0;if(e.parentNode)for(var r=e.parentNode.childNodes,o=0;o<r.length;o++){var l=r[o];if(l===e)return i(e.parentNode)+"/"+e.tagName+"["+(n+1)+"]";1===l.nodeType&&l.tagName===e.tagName&&n++}}function l(e){var n=i(e);e.queryCache&&delete e.queryCache,e.parentNode.removeChild(e),p[n+"-config"]&&p[n+"-config"].configContext&&"function"==typeof p[n+"-config"].configContext.onunload&&p[n+"-config"].configContext.onunload(p[n+"-config"].configContext,e,JSON.parse(p[n]),n),delete p[n];for(var t in p)0===t.indexOf(n)&&delete p[t]}function a(e){return(e=e&&parseInt(e.split("[").pop().slice(0,-1)))?parseInt(e)-1:0}function c(e,n,t){var r,a,d;if(e){null==n&&(n={_text:""});var s=f(e);if(d=o(n)){if(m[t]&&0===s.length&&(m[t].parent.insertAdjacentHTML("beforeend",m[t].node),s=f(m[t].parent.children),"object"==typeof n[0]&&(n[0].__magnum__=s[0].__key=0)),0===s.length)return;for(a=s[0].parentNode,m[t]||(m[t]={node:s[0].cloneNode(!0).outerHTML,parent:a});s.length<n.length;){var g=s.length;m[t]?(a.insertAdjacentHTML("beforeend",m[t].node),r=a.lastChild):r=s[0].cloneNode(!0),"object"==typeof n[g]&&(n[g].__magnum__=g,r.__key=g++),s.push(r),a&&a.appendChild(r)}if(s.length>n.length)if(0==n.length||"object"!=typeof n[0])for(;s.length>n.length;)r=s.pop(),(a=r.parentNode)&&l(r);else s=s.filter(function(e){return 0==n.filter(function(n){return n.__magnum__==e.__key}).length?(l(e),!1):!0})}for(t=0;t<s.length;t++)r=i(s[t]),d?!s[t]||p[r]&&p[r]===JSON.stringify(n[t])||(c(s[t],n[t]),p[r]=JSON.stringify(n[t]),s[t].queryCache&&delete s[t].queryCache):u(s[t],n);return e}}function u(e,n){var t;if("function"!=typeof n){if("object"!=typeof n)return u(e,{_text:n});for(var a in n){var f=n[a];f===r?f="":null===f&&-1===["onunload"].indexOf(a)&&h(e,a).forEach(function(e){l(e)}),"_"===a[0]&&"__magnum__"!=a&&(t=t||{},t[a.substr(1)]=f)}var s=i(e);t&&d(e,t);var g=0;for(a in n)if(f=n[a],"_"!==a[0]){if(t=h(e,a),"function"==typeof f&&"fun"==f.type)try{f=f()}catch(v){}o(f)&&(t=h(e,"$"+a)),c(t,f,s+"/"+a),g++}}}function f(e){var n;if(null==e.length&&(e=[e]),!o(e)){n=[];for(var t=0;t<e.length;t+=1)e[t]&&n.push(e[t]);e=n}return e}function d(t,r){var o=i(t),l=!1,c=a(o);p[o]&&p[o]===JSON.stringify(r)&&(l=!0),t._events=t._events||[];for(var u in r)if("text"!==u&&"html"!==u)if(0==u.indexOf("on")){if(-1===t._events.indexOf(u)||y){var f=function(n,t,r,o){try{return n.call(t,o,r,t)}finally{e.redraw()}}.bind(null,r[u],t,c);t[u]=f,t._events.push(u)}}else if("config"==u){f=!0,p[o+"-config"]?f=!1:p[o+"-config"]={};var d=p[o+"-config"].configContext=p[o+"-config"].configContext||{};n.push(function(e,n){return function(){return e.apply(e,n)}}(r[u],[t,f,d,c]))}else f={key:u,cache:l,value:r[u],node:t},e.hook("attributes",u,f),f.change&&(u=f.key,r[u]=f.value),l||(null===r[u]?t.removeAttribute(u):t.setAttribute(u,""+r[u]));l||(s(t,r.text),g(t,r.html),p[o]=JSON.stringify(r),t.queryCache&&delete t.queryCache)}function s(e,n){var t,r;if(i(e),e&&null!=n){if(!r){r=[];for(var o=0;o<e.childNodes.length;o+=1)t=e.childNodes[o],t.nodeType===v&&r.push(t)}for(;e.firstChild;)e.removeChild(e.firstChild);for("input"===e.nodeName.toLowerCase()?e.setAttribute("value",""+n):e.appendChild(e.ownerDocument.createTextNode(""+n)),o=0;o<r.length;o+=1)e.appendChild(r[o])}}function g(e,n){e&&null!=n&&(e.innerHTML=n)}function h(e,n,t){for(var r=e.childNodes,o=[],i=0;i<r.length;i+=1)r[i].nodeType===v&&o.push(r[i]);if(r=[],i=n,!e.queryCache||!e.queryCache[n]||"$"===n[0]){e.queryCache=(e.queryCache||{})[n]=[];var l="$"===n[0];"$"===i[0]&&(i=i.substr(1));for(var a=0;a<o.length;a+=1){var c=o[a],u=i,f=" "+c.className+" ";(c.id===u||-1<f.indexOf(" "+u+" ")||c.name===u||c.nodeName.toLowerCase()===u.toLowerCase()||c.getAttribute("data-bind")===u)&&r.push(o[a])}if(!r.length||l)for(a=0;a<o.length&&(r=r.concat(h(o[a],n,!0)),!r.length||l);a++);!t&&!r.length,e.queryCache[n]=r}return e.queryCache[n]}var v=1,p=[],m={},p=[],y=!1;e.fill={fill:c,find:h,clear:function(){y=!0},unclear:function(){y=!1},configs:n},window.mag=e}(window.mag||{},[],document),function(e){var n={modules:[],promises:[],deferreds:[],controllers:[],elements:[],getController:function(e,n,t){return"undefined"!=typeof Proxy?new Proxy(new e.controller,{get:function(e,r){if(void 0===e[r]&&-1===["watchers","toJSON","called","onload","onunload"].indexOf(r)){var o,i=t.find(n,r),l="$"===r[0],a=[];return i.forEach(function(e,n){i[n]&&(i[n].value&&0<i[n].value.length?(o=i[n].value,!i[n].type||"checkbox"!=i[n].type&&"radio"!=i[n].type||(o={_text:o,_checked:i[n].checked},a.push(o))):i[n].innerText&&0<i[n].innerText.length?o=i[n].innerText:i[0].innerHTML&&0<i[n].innerHTML.length&&(o=i[n].innerHTML))}),0<a.length&&l?a:o}return e[r]}}):new e.controller},submodule:function(e,n){var t=function(n){return(e.controller||function(){}).apply(this,n)}.bind({},n);return t.$original=e.controller,t={controller:t,view:function(t){1<arguments.length&&(n=n.concat([].slice.call(arguments,1)));var r=e.view.apply(e,n?[t].concat(n):[t]);return n[0]&&null!=n[0].key&&(r.attrs.key=n[0].key),r}},n[0]&&null!=n[0].key&&(t.attrs={key:n[0].key}),t},getArgs:function(e){return n.modules[e].controller&&n.modules[e].controller.$$args?[n.controllers[e]].concat(n.modules[e].controller.$$args):[n.controllers[e]]}};e.mod=n}(window.mag||{}),function(e){function n(e,n,t){var r=(n.getArgs(t),n.modules[t]);n=n.controllers[t];try{r.view(e,n)}catch(o){}}function t(e,n){Object.observe(e,function(r){r.forEach(function(r){"object"==typeof e[r.name]&&t(e[r.name],n)}),n.apply(this,arguments)})}var r={roots:[],templates:{},cache:{},callOnload:function(e){for(var n,t=0;n=e.controllers[t];t++)n.onload&&!n.called&&(n.onload.call(null,e.elements[t]),n.called=1)},callConfigs:function(e){for(var n=0,t=e.length;t>n;n++)e[n]()}},o=[];r.redraw=function(e,n,t){e=e||r.module||{},this.fun=this.fun||c(function(){n.configs.splice(0,n.configs.length),r.doLoop(e,n,t)}),this.fun()},r.doLoop=function(n,t,o){for(var i=0;r.roots[i];i++)if(e.running=!0,n.controllers[i]&&r.innerLoop(n,t,i,o)&&(n.deferreds[i][2]({_html:n.elements[i].innerHTML}),n.deferreds[i][0])){var l=n.deferreds[i][1];delete n.elements[l],n.modules[l],n.controllers[l],n.promises[l],n.deferreds[l]}t.unclear()},r.clear=function(e,n,t){-1!==e&&o[e]&&t.clear()},r.innerLoop=function(e,t,i,l){var a=e.elements[i],c=e.getArgs(i);return o[i]&&o[i]===JSON.stringify(c[0])?!1:(n(a,e,i),o[i]=JSON.stringify(c[0]),r.setupWatch(l,c,t,a,i,e),t.fill(a,c[0]),r.callConfigs(t.configs),r.callOnload(e),!0)};var i;r.doWatch=function(t,l,a,c,u,f){f!=i&&(i=f,e.running=!0,u=c.getArgs(a),o[a]&&o[a]===JSON.stringify(u[0])||(n(l,c,a),o[a]=JSON.stringify(u[0]),t.fill(l,u[0]),r.callConfigs(t.configs),e.running=!1))},r.setupWatch=function(e,n,o,i,l,a){t(n[0],function(e){c(r.doWatch.bind(null,o,i,l,a,e))()})};var l=window.cancelAnimationFrame||window.clearTimeout,a=window.requestAnimationFrame||window.setTimeout,c=function(e,n){var t,r,o=n||16;return function(){if(+new Date-t>o||a===window.requestAnimationFrame){r>0&&l(r);var n=arguments;r=a(function(){t=+new Date;var r=[].slice.call(arguments).concat([].slice.call(n));e.apply(this,r)},o)}else{t=+new Date;var i=[].slice.call(arguments).concat([].slice.call(n));e.apply(this,i),r=a(function(){r=null},o)}}};e.render=r}(window.mag||{}),function(e,n){function t(n){var t=function(){return arguments.length&&(n=arguments[0],e.redraw()),n};return t.type="fun",t.toJSON=function(){return n},t}function r(n,t){var o=e.prop(t);return n.then(o),o.then=function(e,o){return r(n.then(e,o),t)},o}var o=e.mod,i=e.render,l=e.fill,a=e.watch,c={}.toString,u=e.running=!1;e.redraw=function(){u||(u=!0,i.redraw(o||i.module||{},l,a),u=!1)},e.withProp=function(e,n){return function(t){t=t||event,t=t.currentTarget||this,n(e in t?t[e]:t.getAttribute(e))}},e.prop=function(e){return(null!=e&&"[object Object]"===c.call(e)||"function"==typeof e)&&"function"==typeof e.then?r(e):t(e)};var f={attributes:[]};e.hookin=function(e,n,t){f[e].push({context:{},handler:t,key:n})},e.hook=function(e,n,t,r){for(var o in f[e])t.changed=!1,f[e][o].key==n&&(r=JSON.stringify({v:t.value,k:t.key}),f[e][o].handler.call(f[e][o].context,t),r!==JSON.stringify({v:t.value,k:t.key})&&(t.change=!0))};var d=[];e.module=function(t,a,c,u){var f=i.roots.indexOf(t);c&&!c.retain&&i.clear(f,t,l),(0>f||u)&&(f=i.roots.length);for(var s,g=!1,h={preventDefault:function(){g=!0}},v=0;s=d[v];v++)s.handler(h),s.controller.onunload=null;if(g)for(v=0;s=d[v];v++)s.controller.onunload=s.handler;else d=[];return g?void 0:(t=n.getElementById(t))?(i.roots[f]=t.id,a.view?(a=o.submodule(a,[c||{}]),c=o.getController(a,t,l),o.controllers[f]=c,c.onunload&&d.push({controller:c,handler:c.onunload}),o.modules[f]=a,o.elements[f]=u?t.cloneNode(!0):t,o.promises[f]=new Promise(function(){o.deferreds[f]=arguments}.bind(null,u,f)),e.redraw(),c.onload&&!e.running&&i.callOnload(o),r(o.promises[f],{_html:o.elements[f].innerHTML})):Error("module requires a view")):Error("invalid node")}}(window.mag||{},document);
