/*
Mag.JS v0.9.6
http://github.com/magnumjs/mag.js
(c) Michael Glazer
License: MIT
*/
!function(e,n,t,r){function o(e){return"[object Array]"===Object.prototype.toString.call(e)}function i(e){if(""!==e.id)return'id("'+e.id+'")';if(e===t.body)return e.tagName;var n=0;if(e.parentNode)for(var r=e.parentNode.childNodes,o=0;o<r.length;o++){var l=r[o];if(l===e)return i(e.parentNode)+"/"+e.tagName+"["+(n+1)+"]";1===l.nodeType&&l.tagName===e.tagName&&n++}}function l(e){var n=i(e);e.queryCache,e.parentNode.removeChild(e),m[n+"-config"]&&m[n+"-config"].configContext&&"function"==typeof m[n+"-config"].configContext.onunload&&m[n+"-config"].configContext.onunload(m[n+"-config"].configContext,e,m[n],n),delete m[n];for(var t in m)0===t.indexOf(n)&&delete m[t]}function a(e){return(e=e&&parseInt(e.split("[").pop().slice(0,-1)))?parseInt(e)-1:0}function c(e,n,t){var a,u,s;if(e){null==n&&(n={_text:""});var g=d(e);if(s=o(n)){if(b[t]=b[t]||0,w[t]&&0===g.length&&(w[t].parent.insertAdjacentHTML("beforeend",w[t].node),g=d(w[t].parent.children),"object"==typeof n[0]),0===g.length)return;for(u=g[0].parentNode,w[t]||(w[t]={node:g[0].cloneNode(!0).outerHTML,parent:u});g.length<n.length;)w[t]?(u.insertAdjacentHTML("beforeend",w[t].node),a=u.lastChild):a=g[0].cloneNode(!0),g.push(a),u&&u.appendChild(a);if(void 0===g[0].__key&&"object"==typeof n[0],a=n.map(function(e){return e[y]}),(g.length==n.length||-1!==a.indexOf(r))&&(n=n.map(function(e,n){return"object"==typeof e&&(void 0===e[y]&&(e[y]="__magnum__"+b[t]++),g[n].__key=e[y]),e})),g.length>n.length)if(0===n.length||"object"!=typeof n[0])for(;g.length>n.length;)a=g.pop(),(u=a.parentNode)&&l(a);else var h=n.map(function(e){return e[y]}),g=(g.map(function(e){return e.__key}),g.filter(function(e){return-1===h.indexOf(e.__key)?(l(e),!1):!0}))}for(a=0;a<g.length;a++)u=i(g[a]),s?g[a]&&(m[u]&&m[u]===JSON.stringify(n[a]),c(g[a],n[a]),g[a].queryCache):(n&&"object"==typeof n&&-1!==Object.keys(n).indexOf(y)&&(g[a].isChildOfArray=!0,g[a]._dataPass=n),f(g[a],n));return e}}function u(e){return e.parentNode&&e.parentNode.isChildOfArray?e.parentNode:e.parentNode?u(e.parentNode):void 0}function f(e,n){var t;if("function"!=typeof n){if("object"!=typeof n)return f(e,{_text:n});for(var a in n){var u=n[a];u===r?u="":null===u&&-1===["onunload"].indexOf(a)&&v(e,a).forEach(function(e){l(e)}),"_"===a[0]&&(t=t||{},t[a.substr(1)]=u)}var d=i(e);t&&s(e,t);var g=0,h=["willupdate","didupdate","didload","willload"];for(a in n)if(-1===h.indexOf(a)&&(u=n[a],"_"!==a[0])){if(t=v(e,a),"function"==typeof u&&"fun"==u.type)try{u=u()}catch(p){}o(u)&&(t=v(e,"$"+a)),c(t,u,d+"/"+a),g++}}}function d(e){var n;if(null==e.length&&(e=[e]),!o(e)){n=[];for(var t=0;t<e.length;t+=1)e[t]&&n.push(e[t]);e=n}return e}function s(t,r){var o=i(t),l=a(o);m[o]&&m[o]===JSON.stringify(r),t._events=t._events||[];for(var c in r)if("text"!==c&&"html"!==c)if(0==c.indexOf("on")){if(-1===t._events.indexOf(c)||N){var f=function(n,t,r,o,i){try{return n.call(t,i,r,t,o)}finally{e.redraw()}}.bind(null,r[c],t,l,(u(t)||{})._dataPass);t[c]=f,t._events.push(c)}}else if("config"==c){f=!0,m[o+"-config"]?f=!1:m[o+"-config"]={};var d=m[o+"-config"].configContext=m[o+"-config"].configContext||{};n.push(function(e,n){return function(){return e.apply(e,n)}}(r[c],[t,f,d,l]))}else f={key:c,value:r[c],node:t},e.hook("attributes",c,f),f.change&&(c=f.key,r[c]=f.value),null===r[c]?t.removeAttribute(c):t.setAttribute(c,""+r[c]);g(t,r.text),h(t,r.html),t.queryCache}function g(e,n){var t,r;if(i(e),e&&null!=n){if(!r){r=[];for(var o=0;o<e.childNodes.length;o+=1)t=e.childNodes[o],t.nodeType===p&&r.push(t)}for(;e.firstChild;)e.removeChild(e.firstChild);for("input"===e.nodeName.toLowerCase()?e.setAttribute("value",""+n):e.appendChild(e.ownerDocument.createTextNode(""+n)),o=0;o<r.length;o+=1)e.appendChild(r[o])}}function h(e,n){e&&null!=n&&(e.innerHTML=n)}function v(n,t,r){for(var o=n.childNodes,i=[],l=0;l<o.length;l+=1)o[l].nodeType===p&&i.push(o[l]);var o=[],l=t,a="$"===t[0];"$"===l[0]&&(l=l.substr(1));for(var c=0;c<i.length;c+=1){var u=i[c],f=l,d=" "+u.className+" ";(u.id===f||-1<d.indexOf(" "+f+" ")||u.name===f||u.nodeName.toLowerCase()===f.toLowerCase()||u.getAttribute("data-bind")===f)&&o.push(i[c])}if(!o.length||a)for(c=0;c<i.length&&(o=o.concat(v(i[c],t,!0)),!o.length||a);c++);return r||o.length||(n={key:t,value:o,node:n},e.hook("elementMatcher",t,n),n.change),o}var p=1,m=[],y="_key",w={},m=[],b={},N=!1;e.fill={fill:c,find:v,clear:function(){N=!0},unclear:function(){N=!1},configs:n},window.mag=e}(window.mag||{},[],document),function(e){var n={modules:[],promises:[],deferreds:[],controllers:[],elements:[],getController:function(e,n,t){return"undefined"!=typeof Proxy?new Proxy(new e.controller,{get:function(e,r){if(void 0===e[r]&&-1===["watchers","toJSON","called","onload","onunload"].indexOf(r)){var o,i=t.find(n,r),l="$"===r[0],a=[];return i.forEach(function(e,n){i[n]&&(i[n].value&&0<i[n].value.length?(o=i[n].value,!i[n].type||"checkbox"!=i[n].type&&"radio"!=i[n].type||(o={_text:o,_checked:i[n].checked},a.push(o))):i[n].innerText&&0<i[n].innerText.length?o=i[n].innerText:i[0].innerHTML&&0<i[n].innerHTML.length&&(o=i[n].innerHTML))}),0<a.length&&l?a:o}return e[r]}}):new e.controller},submodule:function(e,n){var t=function(n){return(e.controller||function(){}).apply(this,n)}.bind({},n);return t.$original=e.controller,t={controller:t,view:function(t){if(1<arguments.length)var r=n.concat([].slice.call(arguments,1));r=e.view.apply(e,r?[t].concat(r):[t]),n[0]&&null!=n[0].key&&(r.attrs.key=n[0].key)}},n[0]&&null!=n[0].key&&(t.attrs={key:n[0].key}),t},getArgs:function(e){return n.modules[e].controller&&n.modules[e].controller.$$args?[n.controllers[e]].concat(n.modules[e].controller.$$args):[n.controllers[e]]}};e.mod=n}(window.mag||{}),function(e){function n(e,n,t){var o=(n.getArgs(t),n.modules[t]);n=n.controllers[t];var i=r.contexts[t]=r.contexts[t]||{};try{o.view(n,e,i)}catch(l){console.log(e.id,t,l)}}function t(e,n){e&&void 0!==Object.observe&&Object.observe(e,function(r){r.forEach(function(r){"object"==typeof e[r.name]&&t(e[r.name],n)}),n.apply(this,arguments)})}var r={roots:[],contexts:[],templates:{},cache:{},callLCEvent:function(e,n,t,r){n.controllers[t][e]&&(n.controllers[t][e].call({},n.elements[t]),r&&(n.controllers[t][e]=0))},callConfigs:function(e){for(var n=0,t=e.length;t>n;n++)e[n]()}},o=[];r.redraw=function(e,n){e=e||r.module||{},this.fun=this.fun||c(function(){n.configs.splice(0,n.configs.length),r.doLoop(e,n)}),this.fun()},r.doLoop=function(n,t){for(var o=0;r.roots[o];o++)if(e.running=!0,n.controllers[o]&&n.elements[o]&&(r.callLCEvent("willload",n,o,1),r.innerLoop(n,t,o)&&(n.deferreds[o][2]({_html:n.elements[o].innerHTML}),r.callLCEvent("didload",n,o,1),r.callConfigs(t.configs),n.deferreds[o][0]))){var i=n.deferreds[o][1];delete n.elements[i],n.modules[i],n.controllers[i],n.promises[i],n.deferreds[i]}t.unclear()},r.clear=function(e,n,t){-1!==e&&o[e]&&t.clear()},r.innerLoop=function(e,t,i){var l=e.elements[i],a=e.getArgs(i);return o[i]&&o[i]===JSON.stringify(a[0])?!1:(n(l,e,i),o[i]=JSON.stringify(a[0]),r.setupWatch(a,t,l,i,e),t.fill(l,a[0]),!0)};var i;r.doWatch=function(t,l,a,c,u,f){if(f!=i){if(i=f,e.running=!0,r.callLCEvent("willupdate",c,a,1),u=c.getArgs(a),o[a]&&o[a]===JSON.stringify(u[0]))return void r.callLCEvent("didupdate",c,a);n(l,c,a),o[a]=JSON.stringify(u[0]),t.fill(l,u[0]),e.running=!1}},r.setupWatch=function(e,n,o,i,l){t(e[0],function(e){c(r.doWatch.bind({},n,o,i,l,e))()})};var l=window.cancelAnimationFrame||window.clearTimeout,a=window.requestAnimationFrame||window.setTimeout,c=function(e,n){var t,r,o=n||16;return function(){if(+new Date-t>o||a===window.requestAnimationFrame){r>0&&l(r);var n=arguments;r=a(function(){t=+new Date;var r=[].slice.call(arguments).concat([].slice.call(n));e.apply(this,r)},o)}else{t=+new Date;var i=[].slice.call(arguments).concat([].slice.call(n));e.apply(this,i),r=a(function(){r=null},o)}}};e.render=r}(window.mag||{}),function(e,n){function t(n){var t=function(){return arguments.length&&(n=arguments[0],e.redraw()),n};return t.type="fun",t.toJSON=function(){return n},t}function r(n,t){var o=e.prop(t);return n.then(o),o.then=function(e,o){return r(n.then(e,o),t)},o}function o(e){for(var n,t=!1,r={preventDefault:function(){t=!0}},o=0;n=s[o];o++);if(t)for(o=0;n=s[o];o++)n.controller.onunload=n.handler;else s=[];return i.controllers[e]&&typeof i.controllers[e].onunload===u&&(i.controllers[e].onunload(r),i.controllers[e].onunload=0),t}var i=e.mod,l=e.render,a=e.fill,c={}.toString,u="function",f=e.running=!1;e.redraw=function(){f||(f=!0,l.redraw(i||l.module||{},a),f=!1)},e.withProp=function(e,n){return function(t){t=t||event,t=t.currentTarget||this,n(e in t?t[e]:t.getAttribute(e))}},e.prop=function(e){return(null!=e&&"[object Object]"===c.call(e)||typeof e===u)&&typeof e.then===u?r(e):t(e)};var d={attributes:[],elementMatcher:[]};e.hookin=function(e,n,t){d[e].push({context:{},handler:t,key:n})},e.hook=function(e,n,t,r){for(var o in d[e])t.changed=!1,d[e][o].key==n&&(r=JSON.stringify({v:t.value,k:t.key}),d[e][o].handler.call(d[e][o].context,t),r!==JSON.stringify({v:t.value,k:t.key})&&(t.change=!0))};var s=[];e.module=function(t,c,u,f){var d=l.roots.indexOf(t);return d>-1&&o(d)?void 0:(u&&!u.retain&&l.clear(d,t,a),(0>d||f)&&(d=l.roots.length),(t=n.getElementById(t))?(l.roots[d]=t.id,c.view?(c=i.submodule(c,[Object.freeze(u||{})]),u=i.getController(c,t,a),i.controllers[d]=u,u.onunload&&s.push({controller:u,handler:u.onunload}),i.modules[d]=c,i.elements[d]=f?t.cloneNode(!0):t,i.promises[d]=new Promise(function(){i.deferreds[d]=arguments}.bind({},f,d)),e.redraw(),r(i.promises[d],{_html:i.elements[d].innerHTML})):Error("Mag.JS module - requires a view")):Error("Mag.JS Module - invalid node"))}}(window.mag||{},document);
